<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨ V4.3</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --primary-color: #4285F4;
            --primary-dark: #3367d6;
            --secondary-color: #34A853;
            --accent-color: #FBBC05;
            --danger-color: #EA4335;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --text-light: #ffffff;
            --bg-main: #f8f9fa;
            --bg-content: #ffffff;
            --bg-hover: #f1f3f4;
            --bg-active: #e8f0fe;
            --border-color: #dadce0;
            --border-radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --spacing: 16px;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; font-family: var(--font-family); color: var(--text-primary); overflow: hidden; background-color: var(--bg-main); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .header { background: var(--bg-content); color: var(--text-primary); padding: 0 var(--spacing); height: 60px; display: flex; align-items: center; border-bottom: 1px solid var(--border-color); z-index: 1000; }
        .header h1 { margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 10px; color: var(--primary-color); }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 340px; background: var(--bg-main); border-right: 1px solid var(--border-color); overflow-y: auto; padding: var(--spacing); }
        .control-section { background: var(--bg-content); border-radius: var(--border-radius); padding: calc(var(--spacing) * 1.5); box-shadow: var(--shadow-sm); margin-bottom: var(--spacing); }
        .control-section h2 { margin: 0 0 var(--spacing) 0; font-size: 1.1rem; color: var(--text-primary); font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .control-group { margin-bottom: var(--spacing); position: relative; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: var(--text-secondary); }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; background-color: var(--bg-main); }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--bg-active); }
        .pac-target-input { padding-right: 30px !important; }
        .clear-search-btn { position: absolute; right: 10px; top: 38px; background: none; border: none; cursor: pointer; color: var(--text-secondary); display: none; }
        .clear-search-btn:hover { color: var(--text-primary); }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn .material-symbols-outlined { font-size: 1.25rem; }
        .btn-primary { background: var(--primary-color); color: var(--text-light); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .btn-accent { background: var(--accent-color); color: var(--text-light); margin-top: 10px; }
        .btn-accent:hover:not(:disabled) { background: #f9ab00; box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .btn-secondary { background-color: var(--bg-content); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-hover); }
        .checkbox-group { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 8px; }
        .checkbox-group:hover { background-color: var(--bg-hover); }
        .checkbox-group input[type="checkbox"] { width: 1.2em; height: 1.2em; margin: 0; accent-color: var(--primary-color); }
        .checkbox-group label { margin: 0; cursor: pointer; font-weight: 500; color: var(--text-primary); }
        .map-section { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .map-container { flex: 3; background: #e0e0e0; min-height: 0; }
        .results-container { flex: 2; border-top: 1px solid var(--border-color); background: var(--bg-content); display: flex; flex-direction: column; min-height: 0; }
        .results-header { padding: 12px var(--spacing); background: var(--bg-content); border-bottom: 1px solid var(--border-color); font-weight: 700; display: flex; justify-content: space-between; align-items: center; z-index: 10; flex-shrink: 0; }
        .results-content { overflow-y: auto; flex-grow: 1; }
        #load-more-container { padding: var(--spacing); text-align: center; border-top: 1px solid var(--border-color); background: var(--bg-content); flex-shrink: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .place-item { animation: fadeIn 0.4s ease-out forwards; padding: var(--spacing); border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s, border-left 0.2s; border-left: 4px solid transparent; }
        .place-item:hover { background-color: var(--bg-hover); }
        .place-item.active { background-color: var(--bg-active); border-left-color: var(--primary-color); }
        .place-info h4 { margin: 0 0 8px 0; font-size: 1.05rem; font-weight: 700; }
        .place-meta { display: flex; align-items: center; flex-wrap: wrap; gap: 6px 12px; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary); }
        .meta-item { display: flex; align-items: center; gap: 4px; }
        .meta-item .material-symbols-outlined { font-size: 1.1rem; }
        .rating { color: #f59e0b; font-weight: 700; }
        /* FIX 3: Style for the new rating count element */
        .rating-count { color: var(--text-secondary); }
        .price-level, .place-address { color: var(--text-secondary); }
        .opening-status { padding: 3px 8px; border-radius: 16px; font-size: 0.8rem; font-weight: 500; }
        .opening-status.open { background: #e6f4ea; color: #1e8e3e; }
        .opening-status.closed { background: #fce8e6; color: #d93025; }
        .share-buttons { position: absolute; top: var(--spacing); right: var(--spacing); display: flex; gap: 8px; }
        .share-btn { padding: 6px; background: var(--bg-content); border: 1px solid transparent; border-radius: 50%; font-size: 1.1rem; color: var(--text-secondary); text-decoration: none; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .share-btn:hover { background: var(--bg-hover); color: var(--primary-color); border-color: var(--border-color); }
        .recommendation-card { margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #e8f0fe 0%, #f3f7ff 100%); border: 1px solid #d2e3fc; border-radius: var(--border-radius); text-align: center; display: none; }
        .recommendation-card h3 { margin: 0 0 10px 0; color: #1967d2; font-size: 1.1rem; }
        .winner-name { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
        .loading-spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid var(--bg-hover); border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message, .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .error-message { background: #fce8e6; color: var(--danger-color); border-radius: var(--border-radius); margin: var(--spacing); }
        .empty-state-icon { font-size: 3.5rem; margin-bottom: 16px; color: var(--border-color); }
        .pac-container { border-radius: 8px !important; box-shadow: var(--shadow-sm) !important; z-index: 9999 !important; }
        .pac-item { padding: 10px; font-size: 1rem; color: var(--text-primary); border: none !important; }
        .pac-item:hover { background-color: var(--bg-hover); }
        .pac-item-query { font-size: 1rem; color: var(--text-primary); }
        .pac-icon { display: none; }
        @media (max-width: 768px) { html, body { overflow: auto; height: auto; } .app-container { height: auto; } .main-content { flex-direction: column; overflow: visible; } .sidebar { width: 100%; border-right: none; border-bottom: 2px solid var(--border-color); } .map-section { min-height: 70vh; } .header h1 { font-size: 1.1rem; } .share-buttons { position: static; margin-top: 12px; justify-content: flex-start; } .place-item { display: flex; flex-direction: column; } }
    </style>
</head>
<body>
    <!-- HTML Structure is Unchanged -->
    <div class="app-container">
        <header class="header"><h1><span class="material-symbols-outlined">travel_explore</span>é™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨</h1></header>
        <main class="main-content">
            <aside class="sidebar">
                <div class="control-section">
                    <h2><span class="material-symbols-outlined">map</span>æœå°‹åœ°é»</h2>
                    <div class="control-group">
                        <label for="location-search-input">è¼¸å…¥åœ°å€ã€åœ°æ¨™æˆ–å€åŸŸ</label>
                        <input type="text" id="location-search-input" class="form-control" placeholder="ä¾‹å¦‚: å°åŒ—è»Šç«™">
                        <button id="clear-search-btn" class="clear-search-btn" title="æ¸…é™¤åœ°é»"><span class="material-symbols-outlined">close</span></button>
                    </div>
                </div>
                <div class="control-section">
                    <h2><span class="material-symbols-outlined">filter_alt</span>ç¯©é¸æ¢ä»¶</h2>
                    <div class="control-group">
                        <label for="type-select">åº—å®¶é¡å‹ (ç„¡é—œéµå­—æ™‚ç”Ÿæ•ˆ)</label>
                        <select id="type-select" class="form-control"><option value="restaurant">é¤å»³ç¾é£Ÿ</option><option value="cafe">å’–å•¡å»³</option><option value="clothing_store">æœé£¾åº—</option><option value="art_gallery">è—è¡“å±•è¦½</option><option value="book_store">æ›¸åº—</option><option value="store">ç‰¹è‰²å°ç‰©</option></select>
                    </div>
                    <div class="control-group">
                        <label for="keyword-input">é—œéµå­— (å„ªå…ˆ)</label>
                        <input type="text" id="keyword-input" class="form-control" placeholder="ä¾‹å¦‚: å†°ã€æ‹‰éºµã€ä¸é™æ™‚...">
                    </div>
                    <div class="control-group">
                        <label for="radius-select">è·é›¢ç¯„åœ</label>
                        <select id="radius-select" class="form-control"><option value="any" selected>ä¸è¨­å®šè·é›¢</option><option value="1000">1 km ä»¥å…§</option><option value="3000">3 km ä»¥å…§</option><option value="5000">5 km ä»¥å…§</option></select>
                    </div>
                    <div class="control-group">
                        <label for="price-select">åƒ¹ä½</label>
                        <select id="price-select" class="form-control"><option value="any">ä»»ä½•åƒ¹ä½</option><option value="1">1 ($)</option><option value="2">2 ($$)</option><option value="3">3 ($$$)</option><option value="4">4 ($$$$)</option></select>
                    </div>
                    <div class="control-group">
                        <div class="checkbox-group"><input type="checkbox" id="open-now-checkbox"><label for="open-now-checkbox">åªé¡¯ç¤ºç¾åœ¨ç‡Ÿæ¥­ä¸­</label></div>
                    </div>
                    <div class="control-group">
                        <div class="checkbox-group"><input type="checkbox" id="rating-filter-checkbox" checked><label for="rating-filter-checkbox">åªé¡¯ç¤º 4.0â˜… ä»¥ä¸Šåº—å®¶</label></div>
                    </div>
                    <button id="search-button" class="btn btn-primary"><span class="material-symbols-outlined">search</span><span class="btn-text">é–‹å§‹æœå°‹</span></button>
                    <button id="draw-button" class="btn btn-accent"><span class="material-symbols-outlined">casino</span>å¤©é¸ä¹‹åº—ï¼</button>
                    <div id="recommendation" class="recommendation-card"><h3>ğŸ‰ å¤©é¸ä¹‹åº—æ˜¯...</h3><div id="winner-name" class="winner-name"></div></div>
                </div>
            </aside>
            <section class="map-section">
                <div id="map" class="map-container"></div>
                <div class="results-container">
                    <div class="results-header"><span>æœå°‹çµæœ</span><span id="results-count" class="results-count"></span></div>
                    <div id="results" class="results-content">
                        <div class="empty-state"><div class="empty-state-icon material-symbols-outlined">location_off</div><p>é–‹å§‹æ¢ç´¢é™„è¿‘çš„åº—å®¶å§ï¼</p></div>
                    </div>
                    <div id="load-more-container"><button id="load-more-button" class="btn btn-secondary" style="display: none;">è¼‰å…¥æ›´å¤šçµæœ</button></div>
                </div>
            </section>
        </main>
    </div>
    <script>
        class AppState { constructor() { this.map = null; this.userLocation = null; this.initialUserLocation = null; this.userMarker = null; this.currentResults = []; this.markers = []; this.isSearching = false; this.mapLibraries = null; this.lastSearchParams = null; this.activePlaceId = null; } reset() { this.currentResults = []; this.clearMarkers(); this.hideRecommendation(); this.lastSearchParams = null; this.activePlaceId = null; } clearMarkers() { this.markers.forEach(marker => { if (marker && marker.map) { marker.map = null; } }); this.markers = []; } hideRecommendation() { const recommendationElement = document.getElementById('recommendation'); if (recommendationElement) { recommendationElement.style.display = 'none'; } } }
        class Utils { static debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; } static formatPrice(priceLevel) { if (priceLevel == null) return ''; return '$'.repeat(priceLevel); } static formatRating(rating) { return rating ? `${rating.toFixed(1)}` : 'ç„¡è©•åˆ†'; } static createShareText(place) { const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.displayName)}&query_place_id=${place.id}`; return `å˜¿ï¼æˆ‘ç”¨ã€Œé™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨ã€æ‰¾åˆ°ä¸€å®¶å¾ˆæ£’çš„åº—ï¼š\n\nã€${place.displayName}ã€‘\n\næ¨è–¦çµ¦ä½ ï¼\né»æ“ŠæŸ¥çœ‹åœ°åœ–ï¼š${googleMapsUrl}`; } static async copyToClipboard(text) { try { await navigator.clipboard.writeText(text); return true; } catch (err) { console.error('è¤‡è£½å¤±æ•—:', err); return false; } } static showError(message, container = 'results') { const element = document.getElementById(container); if (element) { element.innerHTML = message; } } static showLoading(container = 'results') { const element = document.getElementById(container); if (element) { element.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div>æ­£åœ¨æœå°‹ä¸­...</div>'; } } }
        class MapManager { constructor(appState) { this.appState = appState; this.defaultCenter = { lat: 25.0479, lng: 121.5171 }; } async initialize() { try { const { Map } = await google.maps.importLibrary("maps"); const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker"); this.appState.mapLibraries = { AdvancedMarkerElement, PinElement }; this.appState.map = new Map(document.getElementById("map"), { center: this.defaultCenter, zoom: 15, mapId: "DEMO_MAP_ID", mapTypeControl: false, streetViewControl: false, fullscreenControl: true, zoomControl: true }); await this.getUserLocation(); this.addUserMarker(); return true; } catch (error) { console.error('åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error); Utils.showError('åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€APIé‡‘é‘°æˆ–é‡æ–°æ•´ç†é é¢ã€‚'); return false; } } async getUserLocation() { return new Promise((resolve) => { if (!navigator.geolocation) { this.appState.userLocation = this.defaultCenter; this.appState.initialUserLocation = this.defaultCenter; alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ï¼Œå°‡ä½¿ç”¨é è¨­åœ°é»ã€‚'); resolve(); return; } navigator.geolocation.getCurrentPosition( (position) => { const location = { lat: position.coords.latitude, lng: position.coords.longitude }; this.appState.userLocation = location; this.appState.initialUserLocation = location; this.appState.map.setCenter(this.appState.userLocation); resolve(); }, (error) => { console.error('å®šä½éŒ¯èª¤:', error); this.appState.userLocation = this.defaultCenter; this.appState.initialUserLocation = this.defaultCenter; this.appState.map.setCenter(this.defaultCenter); let message = 'ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œå°‡ä½¿ç”¨é è¨­åœ°é»æœå°‹ã€‚'; if (error.code === error.PERMISSION_DENIED) { message = 'æ‚¨æ‹’çµ•äº†å®šä½æ¬Šé™ï¼Œå°‡ä½¿ç”¨é è¨­åœ°é»æœå°‹ã€‚'; } alert(message); resolve(); }, { timeout: 10000, enableHighAccuracy: true, maximumAge: 300000 } ); }); } addUserMarker() { if (!this.appState.userLocation || !this.appState.mapLibraries) return; const { AdvancedMarkerElement, PinElement } = this.appState.mapLibraries; const userMarkerPin = new PinElement({ background: '#4285F4', borderColor: '#FFFFFF', glyphColor: '#FFFFFF' }); this.appState.userMarker = new AdvancedMarkerElement({ map: this.appState.map, position: this.appState.userLocation, title: "æœå°‹ä¸­å¿ƒ", content: userMarkerPin.element, zIndex: 99 }); } updateUserMarker(location) { if (this.appState.userMarker) { this.appState.userMarker.position = location; } else { this.addUserMarker(); } } addPlaceMarkers(places) { if (!this.appState.mapLibraries) return; const { AdvancedMarkerElement, PinElement } = this.appState.mapLibraries; places.forEach(place => { const placeMarkerPin = new PinElement({ background: '#EA4335', borderColor: '#FFFFFF', glyphColor: '#FFFFFF' }); const marker = new AdvancedMarkerElement({ map: this.appState.map, position: place.location, title: place.displayName, content: placeMarkerPin.element }); this.appState.markers.push(marker); }); } focusOnPlace(place) { if (this.appState.map && place.location) { this.appState.map.panTo(place.location); this.appState.map.setZoom(17); } } }
        
        class SearchManager {
            constructor(appState) { this.appState = appState; }
            async searchNearbyPlaces() { if (!this.appState.userLocation) { alert("æ­£åœ¨ç­‰å¾…å®šä½ï¼Œè«‹ç¨å¾Œå†è©¦..."); return; } if (this.appState.isSearching) { return; } this.appState.isSearching = true; this.updateSearchButton(true); document.getElementById('load-more-button').style.display = 'none'; this.appState.reset(); Utils.showLoading(); try { const searchParams = this.getSearchParameters(); this.appState.lastSearchParams = searchParams; const { Place } = await google.maps.importLibrary("places"); let initialPlaces = await this.performSearch(Place, searchParams); if (!initialPlaces || initialPlaces.length === 0) { Utils.showError('<div class="empty-state"><div class="empty-state-icon material-symbols-outlined">search_off</div><p>æ‰¾ä¸åˆ°ä»»ä½•åº—å®¶ï¼Œè«‹å˜—è©¦æ›´æ›é—œéµå­—æˆ–ç§»å‹•åœ°åœ–ã€‚</p></div>'); return; } const filteredResults = this.filterResults(initialPlaces, searchParams); this.appState.currentResults = filteredResults; this.displayResults(filteredResults); if (searchParams.keyword && initialPlaces.length === 20) { document.getElementById('load-more-button').style.display = 'block'; } } catch (error) { console.error('æœå°‹éŒ¯èª¤:', error); Utils.showError('æœå°‹éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'); } finally { this.appState.isSearching = false; this.updateSearchButton(false); } }
            async loadMorePlaces() { const loadMoreBtn = document.getElementById('load-more-button'); if (this.appState.isSearching || !this.appState.lastSearchParams || !this.appState.lastSearchParams.keyword) { return; } this.appState.isSearching = true; loadMoreBtn.disabled = true; loadMoreBtn.innerHTML = '<div class="loading-spinner"></div>è¼‰å…¥ä¸­...'; try { const { Place } = await google.maps.importLibrary("places"); const exclusionQuery = this.appState.currentResults.map(p => `-"${p.displayName.replace(/"/g, '')}"`).join(' '); const newTextQuery = `${this.appState.lastSearchParams.keyword} ${exclusionQuery}`; const newParams = { ...this.appState.lastSearchParams, textQuery: newTextQuery }; let newPlaces = await this.performSearch(Place, newParams); if (!newPlaces || newPlaces.length === 0) { loadMoreBtn.style.display = 'none'; return; } const existingPlaceIds = new Set(this.appState.currentResults.map(p => p.id)); const uniqueNewPlaces = newPlaces.filter(p => !existingPlaceIds.has(p.id)); if (uniqueNewPlaces.length > 0) { const filteredNewResults = this.filterResults(uniqueNewPlaces, this.appState.lastSearchParams); this.appState.currentResults.push(...filteredNewResults); this.appendResults(filteredNewResults); } if (newPlaces.length < 20) { loadMoreBtn.style.display = 'none'; } } catch (error) { console.error('è¼‰å…¥æ›´å¤šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error); alert('è¼‰å…¥æ›´å¤šçµæœæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚'); } finally { this.appState.isSearching = false; loadMoreBtn.disabled = false; loadMoreBtn.textContent = 'è¼‰å…¥æ›´å¤šçµæœ'; } }
            getSearchParameters() { return { radius: document.getElementById('radius-select').value, type: document.getElementById('type-select').value, price: document.getElementById('price-select').value, keyword: document.getElementById('keyword-input').value.trim(), isOpenNow: document.getElementById('open-now-checkbox').checked, isRatingFilterEnabled: document.getElementById('rating-filter-checkbox').checked }; }
            
            // FIX 1: Add 'userRatingCount' to the fields array
            async performSearch(Place, params) {
                const baseFields = [ 'displayName', 'location', 'rating', 'priceLevel', 'formattedAddress', 'id', 'regularOpeningHours', 'businessStatus', 'userRatingCount' ];
                const textQuery = params.textQuery || params.keyword;
                if (textQuery) { const request = { fields: baseFields, textQuery: textQuery, maxResultCount: 20, ...(params.isOpenNow && { isOpenNow: true }) }; const radiusForBias = (params.radius === 'any') ? 50000 : parseInt(params.radius, 10); request.locationBias = { center: this.appState.userLocation, radius: radiusForBias }; const response = await Place.searchByText(request); return response.places; } else { const request = { fields: baseFields, includedTypes: [params.type], maxResultCount: 20 }; const radiusForRestriction = (params.radius === 'any') ? 5000 : parseInt(params.radius, 10); request.locationRestriction = { center: this.appState.userLocation, radius: radiusForRestriction }; const response = await Place.searchNearby(request); return response.places; }
            }
            
            filterResults(initialPlaces, params) { return initialPlaces.filter(place => { if (params.isRatingFilterEnabled && place.rating && place.rating < 4.0) return false; if (params.price !== 'any') { const maxPrice = parseInt(params.price, 10); if (place.priceLevel == null || place.priceLevel > maxPrice) return false; } if (params.isOpenNow && place.regularOpeningHours && place.regularOpeningHours.openNow === false) return false; return true; }); }
            displayResults(places) { const resultsElement = document.getElementById('results'); const countElement = document.getElementById('results-count'); resultsElement.innerHTML = ''; countElement.textContent = `æ‰¾åˆ° ${places.length} é–“åº—å®¶`; const mapManager = new MapManager(this.appState); mapManager.addPlaceMarkers(places); if (places.length === 0) { resultsElement.innerHTML = `<div class="empty-state"><div class="empty-state-icon material-symbols-outlined">wrong_location</div><p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åº—å®¶ã€‚<br>è«‹å˜—è©¦æ”¾å¯¬ç¯©é¸æ¢ä»¶ã€‚</p></div>`; return; } places.forEach(place => { const placeElement = this.createPlaceElement(place); resultsElement.appendChild(placeElement); }); }
            appendResults(places) { const resultsElement = document.getElementById('results'); const countElement = document.getElementById('results-count'); countElement.textContent = `æ‰¾åˆ° ${this.appState.currentResults.length} é–“åº—å®¶`; const mapManager = new MapManager(this.appState); mapManager.addPlaceMarkers(places); places.forEach(place => { const placeElement = this.createPlaceElement(place); resultsElement.appendChild(placeElement); }); }
            
            // FIX 2: Update createPlaceElement to display the userRatingCount
            createPlaceElement(place) {
                const placeItem = document.createElement('div'); placeItem.className = 'place-item'; placeItem.dataset.placeId = place.id;
                if (place.id === this.appState.activePlaceId) { placeItem.classList.add('active'); }
                const placeInfo = document.createElement('div'); placeInfo.className = 'place-info';
                placeInfo.appendChild(this.createShareButtons(place));
                const title = document.createElement('h4'); title.textContent = place.displayName;
                const meta = document.createElement('div'); meta.className = 'place-meta';
                
                if (place.rating) {
                    const ratingText = Utils.formatRating(place.rating);
                    const ratingCount = place.userRatingCount ? `<span class="rating-count">(${place.userRatingCount})</span>` : '';
                    meta.innerHTML += `<div class="meta-item rating"><span class="material-symbols-outlined">star</span> ${ratingText} ${ratingCount}</div>`;
                }

                const priceText = Utils.formatPrice(place.priceLevel);
                if (priceText) { meta.innerHTML += `<div class="meta-item price-level"><span class="material-symbols-outlined">paid</span> ${priceText}</div>`; }
                if (place.regularOpeningHours && typeof place.regularOpeningHours.openNow !== 'undefined') { const isOpen = place.regularOpeningHours.openNow; meta.innerHTML += `<div class="meta-item opening-status ${isOpen ? 'open' : 'closed'}">${isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'å·²æ‰“çƒŠ'}</div>`; }
                
                const address = document.createElement('p'); address.className = 'place-address'; address.textContent = place.formattedAddress || 'åœ°å€è³‡è¨Šä¸å¯ç”¨';
                placeInfo.appendChild(title); placeInfo.appendChild(meta); placeInfo.appendChild(address);
                placeItem.appendChild(placeInfo);
                placeItem.addEventListener('click', (e) => { if (e.target.closest('.share-buttons')) return; this.appState.activePlaceId = place.id; document.querySelectorAll('.place-item').forEach(item => item.classList.remove('active')); placeItem.classList.add('active'); new MapManager(this.appState).focusOnPlace(place); });
                return placeItem;
            }

            createShareButtons(place) { const shareContainer = document.createElement('div'); shareContainer.className = 'share-buttons'; const shareText = Utils.createShareText(place); const lineButton = document.createElement('a'); lineButton.className = 'share-btn'; lineButton.innerHTML = `<span class="material-symbols-outlined">share</span>`; lineButton.href = `https://line.me/R/msg/text/?${encodeURIComponent(shareText)}`; lineButton.target = '_blank'; lineButton.rel = 'noopener noreferrer'; const copyButton = document.createElement('button'); copyButton.className = 'share-btn'; copyButton.innerHTML = `<span class="material-symbols-outlined">content_copy</span>`; copyButton.addEventListener('click', async (e) => { e.stopPropagation(); const success = await Utils.copyToClipboard(shareText); if (success) { copyButton.innerHTML = `<span class="material-symbols-outlined">done</span>`; setTimeout(() => { copyButton.innerHTML = `<span class="material-symbols-outlined">content_copy</span>`; }, 2000); } else { alert('è¤‡è£½å¤±æ•—'); } }); shareContainer.appendChild(lineButton); shareContainer.appendChild(copyButton); return shareContainer; }
            updateSearchButton(isLoading) { const button = document.getElementById('search-button'); const buttonText = button.querySelector('.btn-text'); if (isLoading) { button.disabled = true; buttonText.textContent = 'æœå°‹ä¸­...'; } else { button.disabled = false; buttonText.textContent = 'é–‹å§‹æœå°‹'; } }
            drawWinner() { if (this.appState.currentResults.length === 0) { alert("è«‹å…ˆæœå°‹ï¼Œæ‰èƒ½æŠ½ç±¤å–”ï¼"); return; } const randomIndex = Math.floor(Math.random() * this.appState.currentResults.length); const winner = this.appState.currentResults[randomIndex]; const recommendationDiv = document.getElementById('recommendation'); const winnerNameDiv = document.getElementById('winner-name'); winnerNameDiv.textContent = winner.displayName; recommendationDiv.style.display = 'block'; new MapManager(this.appState).focusOnPlace(winner); const winnerElement = document.querySelector(`.place-item[data-place-id="${winner.id}"]`); if (winnerElement) { winnerElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); document.querySelectorAll('.place-item').forEach(item => item.classList.remove('active')); winnerElement.classList.add('active'); } }
        }
        class StoreDetectorApp { constructor() { this.appState = new AppState(); this.mapManager = new MapManager(this.appState); this.searchManager = new SearchManager(this.appState); } async initialize() { try { if (!await this.mapManager.initialize()) return false; this.bindEventListeners(); this.initializeAutocomplete(); this.setupInitialState(); console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ'); return true; } catch (error) { console.error('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:', error); Utils.showError('æ‡‰ç”¨ç¨‹å¼è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚'); return false; } } initializeAutocomplete() { const input = document.getElementById('location-search-input'); const clearButton = document.getElementById('clear-search-btn'); const autocompleteOptions = { componentRestrictions: { country: "tw" }, fields: ["geometry", "name"], types: ["establishment", "geocode"] }; const autocomplete = new google.maps.places.Autocomplete(input, autocompleteOptions); autocomplete.addListener('place_changed', () => { const place = autocomplete.getPlace(); if (!place.geometry || !place.geometry.location) { alert(`æ‰¾ä¸åˆ° "${place.name}" çš„è©³ç´°è³‡è¨Š`); return; } const newLocation = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() }; this.appState.userLocation = newLocation; this.appState.map.setCenter(newLocation); this.appState.map.setZoom(15); this.mapManager.updateUserMarker(newLocation); clearButton.style.display = 'block'; this.searchManager.searchNearbyPlaces(); }); clearButton.addEventListener('click', () => { input.value = ''; clearButton.style.display = 'none'; input.focus(); }); input.addEventListener('input', () => { if (input.value === '') { clearButton.style.display = 'none'; } }); } bindEventListeners() { document.getElementById('search-button').addEventListener('click', () => this.searchManager.searchNearbyPlaces()); document.getElementById('draw-button').addEventListener('click', () => this.searchManager.drawWinner()); document.getElementById('load-more-button').addEventListener('click', () => this.searchManager.loadMorePlaces()); const keywordInput = document.getElementById('keyword-input'); const debouncedSearch = Utils.debounce(() => { if (this.appState.currentResults.length > 0) { this.searchManager.searchNearbyPlaces(); } }, 1000); keywordInput.addEventListener('input', debouncedSearch); keywordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { this.searchManager.searchNearbyPlaces(); } }); const autoSearchElements = ['type-select', 'price-select', 'open-now-checkbox', 'radius-select', 'rating-filter-checkbox']; autoSearchElements.forEach(id => { document.getElementById(id).addEventListener('change', () => { if (this.appState.currentResults.length > 0) { setTimeout(() => this.searchManager.searchNearbyPlaces(), 500); } }); }); } setupInitialState() { const keywordInput = document.getElementById('keyword-input'); const typeSelect = document.getElementById('type-select'); typeSelect.addEventListener('change', () => { const placeholders = { 'restaurant': 'ä¾‹å¦‚: æ‹‰éºµã€ä¸é™æ™‚ã€ç´ é£Ÿ...', 'cafe': 'ä¾‹å¦‚: æ‰‹æ²–å’–å•¡ã€ä¸é™æ™‚ã€WiFi...', 'clothing_store': 'ä¾‹å¦‚: éŸ“ç³»ã€vintageã€å¤§å°ºç¢¼...', 'art_gallery': 'ä¾‹å¦‚: ç•¶ä»£è—è¡“ã€æ”å½±å±•...', 'book_store': 'ä¾‹å¦‚: äºŒæ‰‹æ›¸ã€æ–‡å…·ã€å’–å•¡...', 'store': 'ä¾‹å¦‚: æ‰‹ä½œã€è¨­è¨ˆã€ç¦®å“...' }; keywordInput.placeholder = placeholders[typeSelect.value] || 'è¼¸å…¥é—œéµå­—...'; }); typeSelect.dispatchEvent(new Event('change')); } }
        let storeDetectorApp; async function initializeApp() { try { storeDetectorApp = new StoreDetectorApp(); await storeDetectorApp.initialize(); } catch (error) { console.error('åˆå§‹åŒ–éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error); Utils.showError('ç³»çµ±è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚'); } } window.initMap = initializeApp;
    </script>
    <script async defer 
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvKC9RDnx1uUCYrOcm9Mb0IRg00J0PA1c&libraries=maps,marker,places&callback=initMap&loading=async">
    </script>
</body>
</html>