<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨ V3.0</title>
    <style>
        :root {
            --primary-color: #4285F4;
            --secondary-color: #34A853;
            --accent-color: #FBBC05;
            --danger-color: #EA4335;
            --text-color: #333;
            --text-secondary: #555;
            --bg-color: #f8f9fa;
            --border-color: #ddd;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --border-radius: 8px;
            --spacing: 16px;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-color);
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #3367d6 100%);
            color: white;
            padding: var(--spacing);
            text-align: center;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--bg-color);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .controls {
            padding: var(--spacing);
        }

        .control-section {
            margin-bottom: 24px;
        }

        .control-section h2 {
            margin: 0 0 var(--spacing) 0;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .control-group {
            margin-bottom: var(--spacing);
        }

        .control-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #2c8e44 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 168, 83, 0.3);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent-color) 0%, #e2a800 100%);
            color: white;
            margin-top: 10px;
        }

        .btn-accent:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(251, 188, 5, 0.3);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .map-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .map-container {
            flex: 3;
            background: #e0e0e0;
            position: relative;
        }

        .results-container {
            flex: 2;
            border-top: 1px solid var(--border-color);
            overflow-y: auto;
            background: white;
        }

        .results-header {
            padding: var(--spacing);
            background: var(--bg-color);
            border-bottom: 1px solid #eee;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .results-content {
            padding: 0;
        }

        .place-item {
            padding: var(--spacing);
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .place-item:hover {
            background-color: #f5f5f5;
        }

        .place-item:last-child {
            border-bottom: none;
        }

        .place-info h4 {
            margin: 0 0 6px 0;
            font-size: 1rem;
            color: var(--text-color);
        }

        .place-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .rating {
            color: #ff9800;
            font-weight: 500;
        }

        .price-level {
            color: var(--secondary-color);
            font-weight: 500;
        }

        .opening-status {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .opening-status.open {
            background: #e8f5e8;
            color: var(--secondary-color);
        }

        .opening-status.closed {
            background: #ffeaea;
            color: var(--danger-color);
        }

        .place-address {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 0;
        }

        .share-buttons {
            position: absolute;
            top: var(--spacing);
            right: var(--spacing);
            display: flex;
            gap: 6px;
        }

        .share-btn {
            padding: 6px 10px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
        }

        .share-btn:hover {
            background: var(--bg-color);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .recommendation-card {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #e8f0fe 0%, #f3f7ff 100%);
            border: 1px solid #d2e3fc;
            border-radius: var(--border-radius);
            text-align: center;
            display: none;
        }

        .recommendation-card h3 {
            margin: 0 0 10px 0;
            color: #1967d2;
            font-size: 1.1rem;
        }

        .winner-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffeaea;
            color: var(--danger-color);
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            border: 1px solid #ffcdd2;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            html, body {
                overflow: auto;
                height: auto;
            }

            .app-container {
                height: auto;
            }

            .main-content {
                flex-direction: column;
                overflow: visible;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid var(--border-color);
                overflow-y: visible;
            }

            .map-section {
                min-height: 70vh;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .share-buttons {
                position: static;
                margin-top: 8px;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>é™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨ V3.0</h1>
        </header>
        
        <main class="main-content">
            <aside class="sidebar">
                <div class="controls">
                    <section class="control-section">
                        <h2>ç¯©é¸æ¢ä»¶</h2>
                        
                        <div class="control-group">
                            <label for="type-select">åº—å®¶é¡å‹</label>
                            <select id="type-select" class="form-control">
                                <option value="restaurant">é¤å»³ç¾é£Ÿ</option>
                                <option value="cafe">å’–å•¡å»³</option>
                                <option value="clothing_store">æœé£¾åº—</option>
                                <option value="art_gallery">è—è¡“å±•è¦½</option>
                                <option value="book_store">æ›¸åº—</option>
                                <option value="store">ç‰¹è‰²å°ç‰©</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="keyword-input">é—œéµå­— (é¸å¡«)</label>
                            <input type="text" id="keyword-input" class="form-control" placeholder="ä¾‹å¦‚: æ‹‰éºµã€ä¸é™æ™‚...">
                        </div>

                        <div class="control-group">
                            <label for="radius-slider">è·é›¢ç¯„åœ: <span id="radius-value">1</span> km</label>
                            <input type="range" id="radius-slider" class="form-control" min="500" max="5000" step="500" value="1000">
                        </div>

                        <div class="control-group">
                            <label for="price-select">åƒ¹ä½ (é¤å»³é©ç”¨)</label>
                            <select id="price-select" class="form-control">
                                <option value="any">ä»»ä½•åƒ¹ä½</option>
                                <option value="1">1 ($)</option>
                                <option value="2">2 ($$)</option>
                                <option value="3">3 ($$$)</option>
                                <option value="4">4 ($$$$)</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="open-now-checkbox">
                                <label for="open-now-checkbox">åªé¡¯ç¤ºç¾åœ¨ç‡Ÿæ¥­ä¸­</label>
                            </div>
                        </div>

                        <button id="search-button" class="btn btn-primary">
                            <span class="btn-text">é–‹å§‹æœå°‹</span>
                        </button>
                        
                        <button id="draw-button" class="btn btn-accent">
                            ğŸ² å¤©é¸ä¹‹åº—ï¼(æŠ½ä¸€å€‹)
                        </button>

                        <div id="recommendation" class="recommendation-card">
                            <h3>ğŸ‰ å¤©é¸ä¹‹åº—æ˜¯...</h3>
                            <div id="winner-name" class="winner-name"></div>
                        </div>
                    </section>
                </div>
            </aside>

            <section class="map-section">
                <div id="map" class="map-container"></div>
                <div class="results-container">
                    <div class="results-header">
                        <span>æœå°‹çµæœ</span>
                        <span id="results-count" class="results-count"></span>
                    </div>
                    <div id="results" class="results-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <p>è«‹å…è¨±å®šä½ï¼Œç„¶å¾Œé»æ“Šã€Œé–‹å§‹æœå°‹ã€é–‹å§‹æ¢ç´¢é™„è¿‘çš„å„ªè³ªåº—å®¶ã€‚</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç®¡ç†
        class AppState {
            constructor() {
                this.map = null;
                this.userLocation = null;
                this.currentResults = [];
                this.markers = [];
                this.isSearching = false;
                this.mapLibraries = null;
            }

            reset() {
                this.currentResults = [];
                this.clearMarkers();
                this.hideRecommendation();
            }

            clearMarkers() {
                this.markers.forEach(marker => {
                    if (marker && marker.map) {
                        marker.map = null;
                    }
                });
                this.markers = [];
            }

            hideRecommendation() {
                const recommendationElement = document.getElementById('recommendation');
                if (recommendationElement) {
                    recommendationElement.style.display = 'none';
                }
            }
        }

        // å·¥å…·å‡½æ•¸
        class Utils {
            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            static formatPrice(priceLevel) {
                if (priceLevel == null) return '';
                return '$'.repeat(priceLevel);
            }

            static formatRating(rating) {
                return rating ? `${rating} â˜…` : 'ç„¡è©•åˆ†';
            }

            static createShareText(place) {
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.displayName)}&query_place_id=${place.id}`;
                return `å˜¿ï¼æˆ‘ç”¨ã€Œé™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨ã€æ‰¾åˆ°ä¸€å®¶å¾ˆæ£’çš„åº—ï¼š\n\nã€${place.displayName}ã€‘\n\næ¨è–¦çµ¦ä½ ï¼\né»æ“ŠæŸ¥çœ‹åœ°åœ–ï¼š${googleMapsUrl}`;
            }

            static async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (err) {
                    console.error('è¤‡è£½å¤±æ•—:', err);
                    return false;
                }
            }

            static showError(message, container = 'results') {
                const element = document.getElementById(container);
                if (element) {
                    element.innerHTML = `<div class="error-message">${message}</div>`;
                }
            }

            static showLoading(container = 'results') {
                const element = document.getElementById(container);
                if (element) {
                    element.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div>æ­£åœ¨æœå°‹ä¸­...</div>';
                }
            }
        }

        // åœ°åœ–ç®¡ç†é¡
        class MapManager {
            constructor(appState) {
                this.appState = appState;
                this.defaultCenter = { lat: 25.0479, lng: 121.5171 };
            }

            async initialize() {
                try {
                    const { Map } = await google.maps.importLibrary("maps");
                    const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
                    
                    this.appState.mapLibraries = { AdvancedMarkerElement, PinElement };
                    
                    this.appState.map = new Map(document.getElementById("map"), {
                        center: this.defaultCenter,
                        zoom: 15,
                        mapId: "DEMO_MAP_ID",
                        mapTypeControl: false,
                        streetViewControl: false,
                        fullscreenControl: true,
                        zoomControl: true
                    });

                    await this.getUserLocation();
                    this.addUserMarker();
                    
                    return true;
                } catch (error) {
                    console.error('åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error);
                    Utils.showError('åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢ã€‚');
                    return false;
                }
            }

            async getUserLocation() {
                return new Promise((resolve) => {
                    if (!navigator.geolocation) {
                        this.appState.userLocation = this.defaultCenter;
                        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ï¼Œå°‡ä½¿ç”¨é è¨­åœ°é»ã€‚');
                        resolve();
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.appState.userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            this.appState.map.setCenter(this.appState.userLocation);
                            resolve();
                        },
                        (error) => {
                            console.error('å®šä½éŒ¯èª¤:', error);
                            this.appState.userLocation = this.defaultCenter;
                            this.appState.map.setCenter(this.defaultCenter);
                            
                            let message = 'ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œå°‡ä½¿ç”¨é è¨­åœ°é»é€²è¡Œæœå°‹ã€‚';
                            if (error.code === error.PERMISSION_DENIED) {
                                message = 'æ‚¨æ‹’çµ•äº†å®šä½æ¬Šé™ï¼Œå°‡ä½¿ç”¨é è¨­åœ°é»é€²è¡Œæœå°‹ã€‚';
                            }
                            alert(message);
                            resolve();
                        },
                        {
                            timeout: 10000,
                            enableHighAccuracy: true,
                            maximumAge: 300000
                        }
                    );
                });
            }

            addUserMarker() {
                if (!this.appState.userLocation || !this.appState.mapLibraries) return;
                
                const { AdvancedMarkerElement, PinElement } = this.appState.mapLibraries;
                const userMarkerPin = new PinElement({
                    background: '#4285F4',
                    borderColor: '#FFFFFF',
                    glyphColor: '#FFFFFF'
                });
                
                new AdvancedMarkerElement({
                    map: this.appState.map,
                    position: this.appState.userLocation,
                    title: "æ‚¨çš„ä½ç½®",
                    content: userMarkerPin.element
                });
            }

            addPlaceMarkers(places) {
                if (!this.appState.mapLibraries) return;
                
                const { AdvancedMarkerElement, PinElement } = this.appState.mapLibraries;
                
                places.forEach(place => {
                    const placeMarkerPin = new PinElement({
                        background: '#EA4335',
                        borderColor: '#FFFFFF',
                        glyphColor: '#FFFFFF'
                    });
                    
                    const marker = new AdvancedMarkerElement({
                        map: this.appState.map,
                        position: place.location,
                        title: place.displayName,
                        content: placeMarkerPin.element
                    });
                    
                    this.appState.markers.push(marker);
                });
            }

            focusOnPlace(place) {
                if (this.appState.map && place.location) {
                    this.appState.map.panTo(place.location);
                    this.appState.map.setZoom(17);
                }
            }
        }

        // æœå°‹ç®¡ç†é¡
        class SearchManager {
            constructor(appState) {
                this.appState = appState;
            }

            async searchNearbyPlaces() {
                if (!this.appState.userLocation) {
                    alert("æ­£åœ¨ç­‰å¾…å®šä½ï¼Œè«‹ç¨å¾Œå†è©¦...");
                    return;
                }

                if (this.appState.isSearching) {
                    return;
                }

                this.appState.isSearching = true;
                this.updateSearchButton(true);
                this.appState.reset();
                Utils.showLoading();

                try {
                    const searchParams = this.getSearchParameters();
                    const { Place } = await google.maps.importLibrary("places");
                    
                    let initialPlaces = await this.performSearch(Place, searchParams);
                    
                    if (!initialPlaces || initialPlaces.length === 0) {
                        Utils.showError('æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åº—å®¶ï¼Œè«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶ã€‚');
                        return;
                    }

                    const filteredResults = this.filterResults(initialPlaces, searchParams);
                    
                    if (filteredResults.length === 0) {
                        Utils.showError('æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å„ªè³ªåº—å®¶ï¼Œè«‹å˜—è©¦æ”¾å¯¬ç¯©é¸æ¢ä»¶ã€‚');
                        return;
                    }

                    this.appState.currentResults = filteredResults;
                    this.displayResults(filteredResults);

                } catch (error) {
                    console.error('æœå°‹éŒ¯èª¤:', error);
                    Utils.showError('æœå°‹éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                } finally {
                    this.appState.isSearching = false;
                    this.updateSearchButton(false);
                }
            }

            getSearchParameters() {
                return {
                    radius: parseInt(document.getElementById('radius-slider').value),
                    type: document.getElementById('type-select').value,
                    price: document.getElementById('price-select').value,
                    keyword: document.getElementById('keyword-input').value.trim(),
                    isOpenNow: document.getElementById('open-now-checkbox').checked
                };
            }

            async performSearch(Place, params) {
                // ä¿®æ­£ï¼šç§»é™¤ä¸æ”¯æ´çš„ currentOpeningHours å­—æ®µ
                const baseFields = [
                    'displayName', 
                    'location', 
                    'rating', 
                    'priceLevel', 
                    'formattedAddress', 
                    'id', 
                    'regularOpeningHours',
                    'businessStatus'
                ];
                
                if (params.keyword) {
                    const request = {
                        textQuery: params.keyword,
                        fields: baseFields,
                        locationBias: {
                            center: this.appState.userLocation,
                            radius: params.radius
                        },
                        includedType: params.type,
                        // ä¿®æ­£ï¼šåªæœ‰åœ¨å‹¾é¸ã€Œåªé¡¯ç¤ºç‡Ÿæ¥­ä¸­ã€æ™‚æ‰è¨­å®š isOpenNow
                        ...(params.isOpenNow && { isOpenNow: true }),
                        maxResultCount: 20
                    };
                    const response = await Place.searchByText(request);
                    return response.places;
                } else {
                    const request = {
                        fields: baseFields,
                        locationRestriction: {
                            center: this.appState.userLocation,
                            radius: params.radius
                        },
                        includedTypes: [params.type],
                        // ä¿®æ­£ï¼šåªæœ‰åœ¨å‹¾é¸ã€Œåªé¡¯ç¤ºç‡Ÿæ¥­ä¸­ã€æ™‚æ‰è¨­å®š isOpenNow
                        ...(params.isOpenNow && { isOpenNow: true }),
                        maxResultCount: 20
                    };
                    const response = await Place.searchNearby(request);
                    return response.places;
                }
            }

            filterResults(places, params) {
                return places.filter(place => {
                    // è©•åˆ†ç¯©é¸ - åªä¿ç•™4.0æ˜Ÿä»¥ä¸Šæˆ–ç„¡è©•åˆ†çš„åº—å®¶
                    if (place.rating && place.rating < 4.0) {
                        return false;
                    }

                    // åƒ¹ä½ç¯©é¸
                    if (params.price !== 'any') {
                        const maxPrice = parseInt(params.price, 10);
                        if (place.priceLevel != null && place.priceLevel > maxPrice) {
                            return false;
                        }
                    }

                    // ä¿®æ­£ï¼šç§»é™¤å‰ç«¯çš„ç‡Ÿæ¥­ç‹€æ…‹ç¯©é¸ï¼Œå› ç‚º API å·²ç¶“è™•ç†äº†
                    // å¦‚æœç”¨æˆ¶å‹¾é¸äº†ã€Œåªé¡¯ç¤ºç‡Ÿæ¥­ä¸­ã€ï¼ŒAPI è«‹æ±‚ä¸­å·²ç¶“åŒ…å« isOpenNow: true

                    return true;
                });
            }

            displayResults(places) {
                const resultsElement = document.getElementById('results');
                const countElement = document.getElementById('results-count');
                
                resultsElement.innerHTML = '';
                countElement.textContent = `æ‰¾åˆ° ${places.length} é–“åº—å®¶`;

                const mapManager = new MapManager(this.appState);
                mapManager.addPlaceMarkers(places);

                places.forEach(place => {
                    const placeElement = this.createPlaceElement(place);
                    resultsElement.appendChild(placeElement);
                    
                    // èª¿è©¦ï¼šè¼¸å‡ºç‡Ÿæ¥­æ™‚é–“è³‡è¨Šåˆ°æ§åˆ¶å°
                    console.log(`åº—å®¶: ${place.displayName}`, {
                        regularOpeningHours: place.regularOpeningHours,
                        businessStatus: place.businessStatus,
                        openNow: place.regularOpeningHours?.openNow,
                        periods: place.regularOpeningHours?.periods
                    });
                });
            }

            createPlaceElement(place) {
                const placeItem = document.createElement('div');
                placeItem.className = 'place-item';

                const placeInfo = document.createElement('div');
                placeInfo.className = 'place-info';

                const title = document.createElement('h4');
                title.textContent = place.displayName;

                const meta = document.createElement('div');
                meta.className = 'place-meta';

                const rating = document.createElement('span');
                rating.className = 'rating';
                rating.textContent = Utils.formatRating(place.rating);

                const priceLevel = document.createElement('span');
                priceLevel.className = 'price-level';
                const priceText = Utils.formatPrice(place.priceLevel);
                if (priceText) {
                    priceLevel.textContent = priceText;
                }

                meta.appendChild(rating);
                if (priceText) {
                    meta.appendChild(priceLevel);
                }

                // ä¿®æ­£ï¼šç°¡åŒ–ç‡Ÿæ¥­ç‹€æ…‹åˆ¤æ–·é‚è¼¯ï¼Œé¿å…æå‰ return
                if (place.regularOpeningHours) {
                    // æª¢æŸ¥ç‡Ÿæ¥­ç‹€æ…‹
                    if (typeof place.regularOpeningHours.openNow !== 'undefined') {
                        const status = document.createElement('span');
                        const isOpen = place.regularOpeningHours.openNow;
                        status.className = `opening-status ${isOpen ? 'open' : 'closed'}`;
                        status.textContent = isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'å·²æ‰“çƒŠ';
                        meta.appendChild(status);
                    }
                    // å¦‚æœæ²’æœ‰ openNow è³‡è¨Šä½†æœ‰ç‡Ÿæ¥­æ™‚é–“è¨­å®šï¼Œä¸é¡¯ç¤ºç‹€æ…‹
                } else if (place.businessStatus === 'OPERATIONAL') {
                    // å¦‚æœæ²’æœ‰ç‡Ÿæ¥­æ™‚é–“è³‡è¨Šä½†æ¥­å‹™ç‹€æ…‹æ­£å¸¸ï¼Œé¡¯ç¤ºç‡Ÿæ¥­ä¸­
                    const status = document.createElement('span');
                    status.className = 'opening-status open';
                    status.textContent = 'ç‡Ÿæ¥­ä¸­';
                    meta.appendChild(status);
                }

                const address = document.createElement('p');
                address.className = 'place-address';
                address.textContent = place.formattedAddress || 'åœ°å€è³‡è¨Šä¸å¯ç”¨';

                placeInfo.appendChild(title);
                placeInfo.appendChild(meta);
                placeInfo.appendChild(address);

                const shareButtons = this.createShareButtons(place);
                
                placeItem.appendChild(placeInfo);
                placeItem.appendChild(shareButtons);

                // é»æ“Šäº‹ä»¶
                placeItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.share-buttons')) {
                        const mapManager = new MapManager(this.appState);
                        mapManager.focusOnPlace(place);
                    }
                });

                return placeItem;
            }

            createShareButtons(place) {
                const shareContainer = document.createElement('div');
                shareContainer.className = 'share-buttons';

                const shareText = Utils.createShareText(place);

                // LINE åˆ†äº«æŒ‰éˆ•
                const lineButton = document.createElement('a');
                lineButton.className = 'share-btn';
                lineButton.textContent = 'Line';
                lineButton.href = `https://line.me/R/msg/text/?${encodeURIComponent(shareText)}`;
                lineButton.target = '_blank';
                lineButton.rel = 'noopener noreferrer';

                // è¤‡è£½æŒ‰éˆ•
                const copyButton = document.createElement('button');
                copyButton.className = 'share-btn';
                copyButton.textContent = 'è¤‡è£½';
                copyButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const success = await Utils.copyToClipboard(shareText);
                    if (success) {
                        copyButton.textContent = 'å·²è¤‡è£½!';
                        setTimeout(() => {
                            copyButton.textContent = 'è¤‡è£½';
                        }, 2000);
                    } else {
                        alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½å…§å®¹ã€‚');
                    }
                });

                shareContainer.appendChild(lineButton);
                shareContainer.appendChild(copyButton);

                return shareContainer;
            }

            updateSearchButton(isLoading) {
                const button = document.getElementById('search-button');
                const buttonText = button.querySelector('.btn-text');
                
                if (isLoading) {
                    button.disabled = true;
                    buttonText.innerHTML = '<div class="loading-spinner"></div>æœå°‹ä¸­...';
                } else {
                    button.disabled = false;
                    buttonText.textContent = 'é–‹å§‹æœå°‹';
                }
            }

            drawWinner() {
                if (this.appState.currentResults.length === 0) {
                    alert("è«‹å…ˆæœå°‹ï¼Œæ‰èƒ½æŠ½ç±¤å–”ï¼");
                    return;
                }

                const randomIndex = Math.floor(Math.random() * this.appState.currentResults.length);
                const winner = this.appState.currentResults[randomIndex];
                
                const recommendationDiv = document.getElementById('recommendation');
                const winnerNameDiv = document.getElementById('winner-name');
                
                winnerNameDiv.textContent = winner.displayName;
                recommendationDiv.style.display = 'block';

                const mapManager = new MapManager(this.appState);
                mapManager.focusOnPlace(winner);

                // æ»¾å‹•åˆ°ä¸­çåº—å®¶
                const resultsContainer = document.getElementById('results');
                const placeItems = resultsContainer.querySelectorAll('.place-item');
                const winnerElement = Array.from(placeItems).find(item => 
                    item.querySelector('h4').textContent === winner.displayName
                );
                
                if (winnerElement) {
                    winnerElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    winnerElement.style.background = 'linear-gradient(135deg, #fff3cd 0%, #fef8e1 100%)';
                    setTimeout(() => {
                        winnerElement.style.background = '';
                    }, 3000);
                }
            }
        }

        // æ‡‰ç”¨ç¨‹å¼ä¸»é¡
        class StoreDetectorApp {
            constructor() {
                this.appState = new AppState();
                this.mapManager = new MapManager(this.appState);
                this.searchManager = new SearchManager(this.appState);
            }

            async initialize() {
                try {
                    // åˆå§‹åŒ–åœ°åœ–
                    const mapInitialized = await this.mapManager.initialize();
                    if (!mapInitialized) {
                        return false;
                    }

                    // ç¶å®šäº‹ä»¶ç›£è½å™¨
                    this.bindEventListeners();
                    
                    // è¨­ç½®åˆå§‹ç‹€æ…‹
                    this.setupInitialState();
                    
                    console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
                    return true;
                } catch (error) {
                    console.error('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:', error);
                    Utils.showError('æ‡‰ç”¨ç¨‹å¼è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚');
                    return false;
                }
            }

            bindEventListeners() {
                // æœå°‹æŒ‰éˆ•
                document.getElementById('search-button').addEventListener('click', () => {
                    this.searchManager.searchNearbyPlaces();
                });

                // æŠ½ç±¤æŒ‰éˆ•
                document.getElementById('draw-button').addEventListener('click', () => {
                    this.searchManager.drawWinner();
                });

                // è·é›¢æ»‘æ¡¿
                document.getElementById('radius-slider').addEventListener('input', (e) => {
                    document.getElementById('radius-value').textContent = e.target.value / 1000;
                });

                // é—œéµå­—è¼¸å…¥æ¡† - æ·»åŠ é˜²æŠ–å‹•æœå°‹
                const keywordInput = document.getElementById('keyword-input');
                const debouncedSearch = Utils.debounce(() => {
                    if (this.appState.currentResults.length > 0) {
                        this.searchManager.searchNearbyPlaces();
                    }
                }, 1000);
                
                keywordInput.addEventListener('input', debouncedSearch);

                // Enteréµæœå°‹
                keywordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.searchManager.searchNearbyPlaces();
                    }
                });

                // ç¯©é¸æ¢ä»¶è®Šæ›´æ™‚çš„è‡ªå‹•æœå°‹ï¼ˆå¯é¸ï¼‰
                const autoSearchElements = ['type-select', 'price-select', 'open-now-checkbox'];
                autoSearchElements.forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        if (this.appState.currentResults.length > 0) {
                            // å»¶é²è‡ªå‹•æœå°‹ï¼Œé¿å…éæ–¼é »ç¹
                            setTimeout(() => {
                                this.searchManager.searchNearbyPlaces();
                            }, 500);
                        }
                    });
                });

                // è¦–çª—å¤§å°è®Šæ›´æ™‚é‡æ–°èª¿æ•´åœ°åœ–
                window.addEventListener('resize', Utils.debounce(() => {
                    if (this.appState.map) {
                        google.maps.event.trigger(this.appState.map, 'resize');
                    }
                }, 250));

                // éµç›¤å¿«æ·éµ
                document.addEventListener('keydown', (e) => {
                    // Ctrl+Enter æˆ– Cmd+Enter å¿«é€Ÿæœå°‹
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        this.searchManager.searchNearbyPlaces();
                    }
                    
                    // æŒ‰ R éµæŠ½ç±¤
                    if (e.key === 'r' || e.key === 'R') {
                        if (this.appState.currentResults.length > 0 && !e.ctrlKey && !e.metaKey) {
                            e.preventDefault();
                            this.searchManager.drawWinner();
                        }
                    }
                });

                // è™•ç†é é¢é›¢é–‹å‰çš„æ¸…ç†
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });
            }

            setupInitialState() {
                // è¨­ç½®åˆå§‹çš„è·é›¢é¡¯ç¤º
                const radiusSlider = document.getElementById('radius-slider');
                document.getElementById('radius-value').textContent = radiusSlider.value / 1000;

                // è¨­ç½®è¼¸å…¥æ¡†çš„ placeholder æç¤º
                const keywordInput = document.getElementById('keyword-input');
                const typeSelect = document.getElementById('type-select');
                
                typeSelect.addEventListener('change', () => {
                    const selectedType = typeSelect.value;
                    const placeholders = {
                        'restaurant': 'ä¾‹å¦‚: æ‹‰éºµã€ä¸é™æ™‚ã€ç´ é£Ÿ...',
                        'cafe': 'ä¾‹å¦‚: æ‰‹æ²–å’–å•¡ã€ä¸é™æ™‚ã€WiFi...',
                        'clothing_store': 'ä¾‹å¦‚: éŸ“ç³»ã€vintageã€å¤§å°ºç¢¼...',
                        'art_gallery': 'ä¾‹å¦‚: ç•¶ä»£è—è¡“ã€æ”å½±å±•...',
                        'book_store': 'ä¾‹å¦‚: äºŒæ‰‹æ›¸ã€æ–‡å…·ã€å’–å•¡...',
                        'store': 'ä¾‹å¦‚: æ‰‹ä½œã€è¨­è¨ˆã€ç¦®å“...'
                    };
                    keywordInput.placeholder = placeholders[selectedType] || 'è¼¸å…¥é—œéµå­—...';
                });

                // è§¸ç™¼åˆå§‹ placeholder è¨­ç½®
                typeSelect.dispatchEvent(new Event('change'));
            }

            cleanup() {
                // æ¸…ç†åœ°åœ–æ¨™è¨˜
                this.appState.clearMarkers();
                
                // æ¸…ç†äº‹ä»¶ç›£è½å™¨
                if (this.appState.map) {
                    google.maps.event.clearInstanceListeners(this.appState.map);
                }
            }

            // å…¬å…±æ–¹æ³•ï¼šä¾›å¤–éƒ¨èª¿ç”¨
            getCurrentResults() {
                return this.appState.currentResults;
            }

            getMap() {
                return this.appState.map;
            }

            getUserLocation() {
                return this.appState.userLocation;
            }
        }

        // å…¨å±€æ‡‰ç”¨ç¨‹å¼å¯¦ä¾‹
        let storeDetectorApp;

        // åˆå§‹åŒ–å‡½æ•¸
        async function initializeApp() {
            try {
                storeDetectorApp = new StoreDetectorApp();
                const success = await storeDetectorApp.initialize();
                
                if (success) {
                    console.log('ğŸ‰ é™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨ V3.0 å·²æº–å‚™å°±ç·’ï¼');
                    
                    // æ·»åŠ ä¸€äº›æœ‰ç”¨çš„æ§åˆ¶å°å‘½ä»¤ä¾›é–‹ç™¼é™¤éŒ¯ä½¿ç”¨
                    if (typeof window !== 'undefined') {
                        window.storeDetector = {
                            app: storeDetectorApp,
                            search: () => storeDetectorApp.searchManager.searchNearbyPlaces(),
                            draw: () => storeDetectorApp.searchManager.drawWinner(),
                            results: () => storeDetectorApp.getCurrentResults(),
                            location: () => storeDetectorApp.getUserLocation()
                        };
                    }
                } else {
                    console.error('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—');
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
                Utils.showError('ç³»çµ±è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚');
            }
        }

        // éŒ¯èª¤è™•ç†
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€éŒ¯èª¤:', event.error);
            // ä¸è¦åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­é¡¯ç¤ºè©³ç´°éŒ¯èª¤ä¿¡æ¯
            Utils.showError('ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason);
            event.preventDefault();
        });

        // Google Maps API å›èª¿å‡½æ•¸
        window.initMap = initializeApp;

        // DOM è¼‰å…¥å®Œæˆå¾Œçš„å‚™ç”¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // å¦‚æœ Google Maps API å·²ç¶“è¼‰å…¥ä½†å›èª¿æœªåŸ·è¡Œ
            if (typeof google !== 'undefined' && google.maps && !storeDetectorApp) {
                initializeApp();
            }
        });
    </script>

    <!-- Google Maps API -->
    <script async defer 
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvKC9RDnx1uUCYrOcm9Mb0IRg00J0PA1c&libraries=maps,marker,places&callback=initMap&loading=async">
    </script>
</body>
</html>