<!DOCTYPE html>
<html>
<head>
    <title>附近優質店家探測器</title>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style>
        /* CSS 樣式部分保持不變 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* 防止整個頁面滾動 */
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; display: flex; flex-direction: column; }
        #top-bar { background-color: #4285F4; color: white; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; }
        h1 { margin: 0; font-size: 1.5em; }
        #main-content { display: flex; flex: 1; overflow: hidden; }
        #controls { width: 300px; padding: 20px; background: #f8f9fa; overflow-y: auto; border-right: 1px solid #ddd; box-sizing: border-box; }
        #controls h2 { margin-top: 0; }
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input[type="range"] { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #34A853; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #2c8e44; }
        #draw-button { background-color: #FBBC05; margin-top: 10px; }
        #draw-button:hover { background-color: #e2a800; }
        #map-container { flex: 1; display: flex; flex-direction: column; }
        #map { flex: 3; /* 地圖佔 3/5 */ background-color: #e0e0e0; }
        #results { flex: 2; /* 結果列表佔 2/5 */ overflow-y: auto; padding: 10px; box-sizing: border-box; border-top: 1px solid #ddd; }
        .place-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .place-item:hover { background-color: #f0f0f0; }
        .place-item h4 { margin: 0 0 5px 0; }
        .place-item p { margin: 0; font-size: 0.9em; color: #555; }
        #recommendation { margin-top: 20px; padding: 15px; background-color: #e8f0fe; border: 1px solid #d2e3fc; border-radius: 8px; text-align: center; }
        #recommendation h3 { margin-top: 0; color: #1967d2; }

        /* 【第二步修正】加入了這段 Media Query */
        @media (max-width: 768px) {
            html, body {
                overflow: auto; /* 在手機上允許整個頁面滾動 */
                height: auto;
            }
            #main-content {
                flex-direction: column;
                height: auto;
                overflow: visible;
            }
            #controls {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 2px solid #ddd;
                overflow-y: visible;
            }
            #map-container {
                /* 在手機上，地圖和結果列表需要有明確的高度 */
                height: calc(100vh - 58px); /* 佔滿螢幕剩餘高度 (減去頂部 bar 的高度) */
                flex: none; /* 取消 flex 比例 */
            }
            #map { flex: 3; } /* 維持地圖和結果的比例 */
            #results { flex: 2; }
            h1 { font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <!-- HTML 部分完全不變 -->
    <div id="top-bar"><h1>附近優質店家探測器</h1></div>
    <div id="main-content">
        <div id="controls">
            <h2>篩選條件</h2>
            <div class="control-group">
                <label for="type-select">店家類型</label>
                <select id="type-select">
                    <option value="restaurant">餐廳美食</option>
                    <option value="cafe">咖啡廳</option>
                    <option value="clothing_store">服飾店</option>
                    <option value="art_gallery">藝術展覽</option>
                    <option value="book_store">書店</option>
                    <option value="store">特色小物</option>
                </select>
            </div>
            <div class="control-group">
                <label for="radius-slider">距離範圍: <span id="radius-value">1</span> km</label>
                <input type="range" id="radius-slider" min="500" max="5000" step="500" value="1000">
            </div>
            <div class="control-group">
                <label for="price-select">價位 (餐廳適用)</label>
                <select id="price-select">
                    <option value="any">任何價位</option>
                    <option value="1">1 ($)</option>
                    <option value="2">2 ($$)</option>
                    <option value="3">3 ($$$)</option>
                    <option value="4">4 ($$$$)</option>
                </select>
            </div>
            <button id="search-button">開始搜尋</button>
            <button id="draw-button">天選之店！(抽一個)</button>
            <div id="recommendation" style="display: none;">
                <h3>天選之店是...</h3><p id="winner-name"></p>
            </div>
        </div>
        <div id="map-container">
            <div id="map"></div>
            <div id="results"><p>請允許定位，然後點擊「開始搜尋」。</p></div>
        </div>
    </div>

    <!-- JavaScript 部分完全不變 -->
    <script>
        let map, userLocation;
        let currentResults = [];
        let markers = [];
        const mapId = "DEMO_MAP_ID";

        async function init() {
            const defaultCenter = { lat: 25.0479, lng: 121.5171 };
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            map = new Map(document.getElementById("map"), { center: defaultCenter, zoom: 15, mapId: mapId, mapTypeControl: false, streetViewControl: false });
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        map.setCenter(userLocation);
                        new AdvancedMarkerElement({ map: map, position: userLocation, title: "你的位置" });
                    },
                    () => { userLocation = defaultCenter; alert("無法取得您的位置，將使用預設地點進行搜尋。"); }
                );
            } else { userLocation = defaultCenter; alert("您的瀏覽器不支援地理位置功能。"); }
            document.getElementById('search-button').addEventListener('click', searchNearbyPlaces);
            document.getElementById('draw-button').addEventListener('click', drawWinner);
            document.getElementById('radius-slider').addEventListener('input', (e) => { document.getElementById('radius-value').textContent = e.target.value / 1000; });
        }

        async function searchNearbyPlaces() {
            if (!userLocation) { alert("正在等待定位，請稍後再試..."); return; }
            clearResults();
            const { Place } = await google.maps.importLibrary("places");
            const radius = parseInt(document.getElementById('radius-slider').value);
            const type = document.getElementById('type-select').value;
            const price = document.getElementById('price-select').value;
            const request = {
                textQuery: type,
                locationBias: { center: userLocation, radius: radius },
                minRating: 4.0,
                maxResultCount: 20,
                fields: ['displayName', 'location', 'rating', 'priceLevel', 'formattedAddress', 'types'],
            };
            document.getElementById('results').innerHTML = '<p>正在搜尋中...</p>';
            try {
                const { places } = await Place.searchByText(request);
                console.clear();
                console.log(`===== Google API 原始回傳（過濾前有 ${places.length} 筆資料）=====`);
                console.table(places.map(p => ({ name: p.displayName, rating: p.rating, priceLevel: p.priceLevel, types: p.types.join(', ') })));
                console.log("=====================================================");
                const filteredResults = places.filter(place => {
                    if (price === 'any') return true;
                    if (!place.priceLevel) return true;
                    const priceEnumMap = { '1': 'PRICE_LEVEL_INEXPENSIVE', '2': 'PRICE_LEVEL_MODERATE', '3': 'PRICE_LEVEL_EXPENSIVE', '4': 'PRICE_LEVEL_VERY_EXPENSIVE' };
                    return place.priceLevel === priceEnumMap[price];
                });
                if (filteredResults.length === 0) {
                    document.getElementById('results').innerHTML = '<p>找不到符合條件的優質店家。</p>';
                    return;
                }
                currentResults = filteredResults;
                displayResults(filteredResults);
            } catch (error) {
                console.error("Search failed:", error);
                document.getElementById('results').innerHTML = '<p>搜尋失敗或發生錯誤。</p>';
            }
        }
        function displayResults(places) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            const { AdvancedMarkerElement } = google.maps.marker;
            places.forEach(place => {
                const placeItem = document.createElement('div');
                placeItem.className = 'place-item';
                const rating = place.rating ? `${place.rating} ★` : '無評分';
                let priceSymbol = '';
                if (place.priceLevel) {
                    switch(place.priceLevel) {
                        case 'PRICE_LEVEL_INEXPENSIVE':  priceSymbol = '$'; break;
                        case 'PRICE_LEVEL_MODERATE':     priceSymbol = '$$'; break;
                        case 'PRICE_LEVEL_EXPENSIVE':    priceSymbol = '$$$'; break;
                        case 'PRICE_LEVEL_VERY_EXPENSIVE': priceSymbol = '$$$$'; break;
                    }
                }
                placeItem.innerHTML = `<h4>${place.displayName}</h4><p>${rating} ${priceSymbol ? '- ' + priceSymbol : ''}</p><p>${place.formattedAddress}</p>`;
                placeItem.addEventListener('click', () => { map.panTo(place.location); map.setZoom(17); });
                resultsDiv.appendChild(placeItem);
                const marker = new AdvancedMarkerElement({ map: map, position: place.location, title: place.displayName });
                markers.push(marker);
            });
        }
        function drawWinner() {
            if (currentResults.length === 0) { alert("請先搜尋，才能抽籤喔！"); return; }
            const recommendationDiv = document.getElementById('recommendation');
            const randomIndex = Math.floor(Math.random() * currentResults.length);
            const winner = currentResults[randomIndex];
            document.getElementById('winner-name').textContent = `🎉 ${winner.displayName} 🎉`;
            recommendationDiv.style.display = 'block';
            map.panTo(winner.location);
            map.setZoom(17);
        }
        function clearResults() {
            markers.forEach(marker => { marker.map = null; });
            markers = [];
            currentResults = [];
            document.getElementById('results').innerHTML = '';
            document.getElementById('recommendation').style.display = 'none';
        }
        window.initMap = init;
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=API_KEY_AIzaSyDvKC9RDnx1uUCYrOcm9Mb0IRg00J0PA1c&libraries=maps,marker,places&v=beta&callback=initMap" async defer></script>

</body>
</html>

<!-- API_KEY_AIzaSyDvKC9RDnx1uUCYrOcm9Mb0IRg00J0PA1c -->
