<!DOCTYPE html>
<html>
<head>
    <title>é™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨V2.0</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; display: flex; flex-direction: column; }
        #top-bar { background-color: #4285F4; color: white; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; }
        h1 { margin: 0; font-size: 1.5em; }
        #main-content { display: flex; flex: 1; overflow: hidden; }
        #controls { width: 320px; padding: 20px; background: #f8f9fa; overflow-y: auto; border-right: 1px solid #ddd; box-sizing: border-box; }
        #controls h2 { margin-top: 0; }
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #34A853; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #2c8e44; }
        #draw-button { background-color: #FBBC05; margin-top: 10px; }
        #draw-button:hover { background-color: #e2a800; }
        .checkbox-label { display: flex; align-items: center; cursor: pointer; font-weight: normal; }
        .checkbox-label input { width: auto; margin-right: 8px; }
        #map-container { flex: 1; display: flex; flex-direction: column; }
        #map { flex: 3; background-color: #e0e0e0; }
        #results { flex: 2; overflow-y: auto; padding: 10px; box-sizing: border-box; border-top: 1px solid #ddd; }
        .place-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; overflow: hidden; }
        .place-item:hover { background-color: #f0f0f0; }
        .place-item h4 { margin: 0 0 5px 0; }
        .place-item p { margin: 0; font-size: 0.9em; color: #555; }
        .share-buttons-container {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            float: right;
        }
        .share-btn {
            background: none;
            border: 1px solid #ccc;
            color: #555;
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .share-btn:hover {
            background-color: #f0f0f0;
            border-color: #aaa;
        }
        #recommendation { margin-top: 20px; padding: 15px; background-color: #e8f0fe; border: 1px solid #d2e3fc; border-radius: 8px; text-align: center; }
        #recommendation h3 { margin-top: 0; color: #1967d2; }
        @media (max-width: 768px) {
            html, body { overflow: auto; height: auto; }
            #main-content { flex-direction: column; height: auto; overflow: visible; }
            #controls { width: 100%; height: auto; border-right: none; border-bottom: 2px solid #ddd; overflow-y: visible; }
            #map-container { height: calc(100vh - 58px); flex: none; }
            h1 { font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <div id="top-bar"><h1>é™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨</h1></div>
    <div id="main-content">
        <div id="controls">
            <h2>ç¯©é¸æ¢ä»¶</h2>
            <div class="control-group">
                <label for="type-select">åº—å®¶é¡å‹</label>
                <select id="type-select">
                    <option value="restaurant">é¤å»³ç¾é£Ÿ</option>
                    <option value="cafe">å’–å•¡å»³</option>
                    <option value="clothing_store">æœé£¾åº—</option>
                    <option value="art_gallery">è—è¡“å±•è¦½</option>
                    <option value="book_store">æ›¸åº—</option>
                    <option value="store">ç‰¹è‰²å°ç‰©</option>
                </select>
            </div>
            <div class="control-group">
                <label for="keyword-input">é—œéµå­— (é¸å¡«)</label>
                <input type="text" id="keyword-input" placeholder="ä¾‹å¦‚: æ‹‰éºµã€ä¸é™æ™‚...">
            </div>
            <div class="control-group">
                <label for="radius-slider">è·é›¢ç¯„åœ: <span id="radius-value">1</span> km</label>
                <input type="range" id="radius-slider" min="500" max="5000" step="500" value="1000">
            </div>
            <div class="control-group">
                <label for="price-select">åƒ¹ä½ (é¤å»³é©ç”¨)</label>
                <select id="price-select">
                    <option value="any">ä»»ä½•åƒ¹ä½</option>
                    <option value="PRICE_LEVEL_INEXPENSIVE">1 ($)</option>
                    <option value="PRICE_LEVEL_MODERATE">2 ($$)</option>
                    <option value="PRICE_LEVEL_EXPENSIVE">3 ($$$)</option>
                    <option value="PRICE_LEVEL_VERY_EXPENSIVE">4 ($$$$)</option>
                </select>
            </div>
             <div class="control-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="open-now-checkbox">
                    åªé¡¯ç¤ºç¾åœ¨ç‡Ÿæ¥­ä¸­
                </label>
            </div>
            <button id="search-button">é–‹å§‹æœå°‹</button>
            <button id="draw-button">å¤©é¸ä¹‹åº—ï¼(æŠ½ä¸€å€‹)</button>
            <div id="recommendation" style="display: none;">
                <h3>å¤©é¸ä¹‹åº—æ˜¯...</h3><p id="winner-name"></p>
            </div>
        </div>
        <div id="map-container">
            <div id="map"></div>
            <div id="results"><p>è«‹å…è¨±å®šä½ï¼Œç„¶å¾Œé»æ“Šã€Œé–‹å§‹æœå°‹ã€ã€‚</p></div>
        </div>
    </div>

    <script>
        let map, userLocation;
        let currentResults = [];
        let markers = [];
        const mapId = "DEMO_MAP_ID";

        async function init() {
            try {
                const defaultCenter = { lat: 25.0479, lng: 121.5171 };
                const { Map } = await google.maps.importLibrary("maps");
                const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
                map = new Map(document.getElementById("map"), { center: defaultCenter, zoom: 15, mapId: mapId, mapTypeControl: false, streetViewControl: false });
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                            map.setCenter(userLocation);
                            const userMarkerPin = new PinElement({ background: '#4285F4', borderColor: '#FFFFFF', glyphColor: '#FFFFFF' });
                            new AdvancedMarkerElement({ map: map, position: userLocation, title: "ä½ çš„ä½ç½®", content: userMarkerPin.element });
                        },
                        () => { userLocation = defaultCenter; alert("ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œå°‡ä½¿ç”¨é è¨­åœ°é»é€²è¡Œæœå°‹ã€‚"); }
                    );
                } else { userLocation = defaultCenter; alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ã€‚"); }
                document.getElementById('search-button').addEventListener('click', searchNearbyPlaces);
                document.getElementById('draw-button').addEventListener('click', drawWinner);
                document.getElementById('radius-slider').addEventListener('input', (e) => { document.getElementById('radius-value').textContent = e.target.value / 1000; });
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                alert('åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚');
            }
        }
        
        async function searchNearbyPlaces() {
            if (!userLocation) { alert("æ­£åœ¨ç­‰å¾…å®šä½..."); return; }
            clearResults();
            document.getElementById('results').innerHTML = '<p>æ­£åœ¨æœå°‹ä¸­...</p>';
            try {
                const radius = parseInt(document.getElementById('radius-slider').value);
                const type = document.getElementById('type-select').value;
                const price = document.getElementById('price-select').value;
                const keyword = document.getElementById('keyword-input').value.trim();
                const isOpenNow = document.getElementById('open-now-checkbox').checked;
                const { Place } = await google.maps.importLibrary("places");
                let initialPlaces;

                // æ ¹æ“šæœ‰ç„¡é—œéµå­—ï¼Œæ±ºå®šå‘¼å«å“ªå€‹API
                if (keyword) {
                    // æƒ…æ³1ï¼šæœ‰é—œéµå­—ï¼Œä½¿ç”¨ searchByTextï¼Œå®ƒç›´æ¥æ”¯æ´ isOpenNow
                    const request = { textQuery: keyword, fields: ['displayName', 'location', 'rating', 'priceLevel', 'formattedAddress', 'id', 'regularOpeningHours'], locationBias: { center: userLocation, radius: radius }, includedType: type, isOpenNow: isOpenNow, maxResultCount: 20 };
                    const response = await Place.searchByText(request);
                    initialPlaces = response.places;
                } else {
                    // æƒ…æ³2ï¼šç„¡é—œéµå­—ï¼Œä½¿ç”¨ searchNearbyï¼Œå®ƒä¸æ”¯æ´ isOpenNow
                    // å› æ­¤æˆ‘å€‘å…ˆå–å¾—æ‰€æœ‰åº—å®¶ï¼Œç¨å¾Œå†æ‰‹å‹•ç¯©é¸
                    const request = { fields: ['displayName', 'location', 'rating', 'priceLevel', 'formattedAddress', 'id', 'regularOpeningHours'], locationRestriction: { center: userLocation, radius: radius }, includedTypes: [type], maxResultCount: 20 };
                    const response = await Place.searchNearby(request);
                    initialPlaces = response.places;
                }

                if (!initialPlaces || initialPlaces.length === 0) { document.getElementById('results').innerHTML = '<p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åº—å®¶ã€‚</p>'; return; }
                
                // === é€²è¡Œå‰ç«¯ç¯©é¸ ===
                let filteredResults = initialPlaces;

                // é—œéµæ­¥é©Ÿï¼šå¦‚æœæ²’æœ‰é—œéµå­—ä½†å‹¾é¸äº†ã€Œç‡Ÿæ¥­ä¸­ã€ï¼Œå°±åœ¨é€™è£¡æ‰‹å‹•éæ¿¾
                if (!keyword && isOpenNow) {
                    filteredResults = initialPlaces.filter(place => 
                        place.regularOpeningHours && place.regularOpeningHours.openNow === true
                    );
                }

                // æ¥è‘—ï¼Œå°å·²ç¶“éã€Œç‡Ÿæ¥­æ™‚é–“ã€ç¯©é¸çš„çµæœï¼Œå†é€²è¡Œã€Œè©•åˆ†ã€å’Œã€Œåƒ¹ä½ã€çš„ç¯©é¸
                filteredResults = filteredResults.filter(place => {
                    if (!place.rating || place.rating < 4.0) return false;
                    if (price !== 'any' && (!place.priceLevel || place.priceLevel !== price)) return false;
                    return true;
                });

                if (filteredResults.length === 0) { document.getElementById('results').innerHTML = '<p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å„ªè³ªåº—å®¶ã€‚è«‹å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚</p>'; return; }
                
                currentResults = filteredResults;
                displayResults(filteredResults);

            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                document.getElementById('results').innerHTML = `<p>æœå°‹éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`;
            }
        }
        
        async function displayResults(places) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
            places.forEach(place => {
                const placeItemContainer = document.createElement('div');
                placeItemContainer.className = 'place-item';
                const rating = place.rating ? `${place.rating} â˜…` : 'ç„¡è©•åˆ†';
                let priceSymbol = '';
                if (place.priceLevel) {
                    switch(place.priceLevel) {
                        case 'PRICE_LEVEL_INEXPENSIVE': priceSymbol = '$'; break;
                        case 'PRICE_LEVEL_MODERATE': priceSymbol = '$$'; break;
                        case 'PRICE_LEVEL_EXPENSIVE': priceSymbol = '$$$'; break;
                        case 'PRICE_LEVEL_VERY_EXPENSIVE': priceSymbol = '$$$$'; break;
                    }
                }
                const infoDiv = document.createElement('div');
                infoDiv.innerHTML = `<h4>${place.displayName}</h4><p>${rating} ${priceSymbol ? '- ' + priceSymbol : ''}</p><p>${place.formattedAddress || 'åœ°å€è³‡è¨Šä¸å¯ç”¨'}</p>`;
                const shareContainer = document.createElement('div');
                shareContainer.className = 'share-buttons-container';
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.displayName)}&query_place_id=${place.id}`;
                const shareTextForCopy = `å˜¿ï¼æˆ‘ç”¨ã€Œé™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨ã€æ‰¾åˆ°ä¸€å®¶å¾ˆæ£’çš„åº—ï¼š\n\nã€${place.displayName}ã€‘\n\næ¨è–¦çµ¦ä½ ï¼\né»æ“ŠæŸ¥çœ‹åœ°åœ–ï¼š${googleMapsUrl}`;
                const lineButton = document.createElement('a');
                lineButton.className = 'share-btn';
                lineButton.textContent = 'Line';
                lineButton.href = `https://line.me/R/msg/text/?${encodeURIComponent(shareTextForCopy)}`;
                lineButton.target = '_blank';
                lineButton.rel = 'noopener noreferrer';
                const copyButton = document.createElement('button');
                copyButton.className = 'share-btn';
                copyButton.textContent = 'è¤‡è£½';
                copyButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    navigator.clipboard.writeText(shareTextForCopy).then(() => { 
                        alert('åº—å®¶è³‡è¨Šå·²è¤‡è£½ï¼'); 
                    }).catch(err => { console.error('è¤‡è£½å¤±æ•—: ', err); });
                });
                shareContainer.appendChild(lineButton);
                shareContainer.appendChild(copyButton);
                placeItemContainer.appendChild(infoDiv);
                placeItemContainer.appendChild(shareContainer);
                placeItemContainer.addEventListener('click', () => { 
                    map.panTo(place.location); 
                    map.setZoom(17); 
                });
                resultsDiv.appendChild(placeItemContainer);
                const placeMarkerPin = new PinElement({ background: '#EA4335', borderColor: '#FFFFFF', glyphColor: '#FFFFFF' });
                const marker = new AdvancedMarkerElement({ map: map, position: place.location, title: place.displayName, content: placeMarkerPin.element });
                markers.push(marker);
            });
        }
        
        function drawWinner() {
            if (currentResults.length === 0) { alert("è«‹å…ˆæœå°‹ï¼Œæ‰èƒ½æŠ½ç±¤å–”ï¼"); return; }
            const recommendationDiv = document.getElementById('recommendation');
            const randomIndex = Math.floor(Math.random() * currentResults.length);
            const winner = currentResults[randomIndex];
            document.getElementById('winner-name').textContent = `ğŸ‰ ${winner.displayName} ğŸ‰`;
            recommendationDiv.style.display = 'block';
            map.panTo(winner.location);
            map.setZoom(17);
        }
        
        function clearResults() {
            markers.forEach(marker => { marker.map = null; });
            markers = [];
            currentResults = [];
            document.getElementById('results').innerHTML = '';
            document.getElementById('recommendation').style.display = 'none';
        }

        window.initMap = init;
    </script>
    
    <script async defer 
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvKC9RDnx1uUCYrOcm9Mb0IRg00J0PA1c&libraries=maps,marker,places&callback=initMap&loading=async">
    </script>
</body>
</html>
