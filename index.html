<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨ V3.5</title>
    <style>
        :root {
            --primary-color: #4285F4;
            --secondary-color: #34A853;
            --accent-color: #FBBC05;
            --danger-color: #EA4335;
            --text-color: #333;
            --text-secondary: #555;
            --bg-color: #f8f9fa;
            --border-color: #ddd;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --border-radius: 8px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; color: var(--text-color); overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .header { background: linear-gradient(135deg, var(--primary-color) 0%, #3367d6 100%); color: white; padding: var(--spacing); text-align: center; box-shadow: var(--shadow); z-index: 1000; }
        .header h1 { margin: 0; font-size: 1.5rem; font-weight: 600; }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 320px; background: var(--bg-color); border-right: 1px solid var(--border-color); overflow-y: auto; }
        .controls { padding: var(--spacing); }
        .control-section { margin-bottom: 24px; }
        .control-section h2 { margin: 0 0 var(--spacing) 0; font-size: 1.1rem; color: var(--text-color); }
        .control-group { margin-bottom: var(--spacing); }
        .control-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1); }
        .btn { width: 100%; padding: 12px; border: none; border-radius: var(--border-radius); font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block; text-align: center; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, var(--secondary-color) 0%, #2c8e44 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(52, 168, 83, 0.3); }
        .btn-accent { background: linear-gradient(135deg, var(--accent-color) 0%, #e2a800 100%); color: white; margin-top: 10px; }
        .btn-accent:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(251, 188, 5, 0.3); }
        .btn-secondary { background-color: #f1f3f4; color: var(--text-color); border: 1px solid var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background-color: #e8eaed; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .checkbox-group input[type="checkbox"] { width: auto; margin: 0; }
        .checkbox-group label { margin: 0; cursor: pointer; font-weight: normal; }
        .map-section { flex: 1; display: flex; flex-direction: column; position: relative; }
        .map-container { flex: 3; background: #e0e0e0; position: relative; }
        .results-container { flex: 2; border-top: 1px solid var(--border-color); overflow-y: auto; background: white; display: flex; flex-direction: column; }
        .results-header { padding: var(--spacing); background: var(--bg-color); border-bottom: 1px solid #eee; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .results-count { font-size: 0.9rem; color: var(--text-secondary); }
        .results-content { padding: 0; flex-grow: 1; }
        #load-more-container { padding: var(--spacing); text-align: center; }
        .place-item { padding: var(--spacing); border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s; position: relative; }
        .place-item:hover { background-color: #f5f5f5; }
        .place-item:last-child { border-bottom: none; }
        .place-info h4 { margin: 0 0 6px 0; font-size: 1rem; color: var(--text-color); }
        .place-meta { display: flex; align-items: center; gap: 12px; margin-bottom: 6px; font-size: 0.85rem; }
        .rating { color: #ff9800; font-weight: 500; }
        .price-level { color: var(--secondary-color); font-weight: 500; }
        .opening-status { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .opening-status.open { background: #e8f5e8; color: var(--secondary-color); }
        .opening-status.closed { background: #ffeaea; color: var(--danger-color); }
        .place-address { color: var(--text-secondary); font-size: 0.85rem; margin: 0; }
        .share-buttons { position: absolute; top: var(--spacing); right: var(--spacing); display: flex; gap: 6px; }
        .share-btn { padding: 6px 10px; background: white; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.75rem; color: var(--text-secondary); text-decoration: none; transition: all 0.2s; }
        .share-btn:hover { background: var(--bg-color); border-color: var(--primary-color); color: var(--primary-color); }
        .recommendation-card { margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #e8f0fe 0%, #f3f7ff 100%); border: 1px solid #d2e3fc; border-radius: var(--border-radius); text-align: center; display: none; }
        .recommendation-card h3 { margin: 0 0 10px 0; color: #1967d2; font-size: 1.1rem; }
        .winner-name { font-size: 1.2rem; font-weight: 600; color: var(--text-color); }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { background: #ffeaea; color: var(--danger-color); padding: 12px; border-radius: var(--border-radius); margin: 10px 0; border: 1px solid #ffcdd2; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
        @media (max-width: 768px) {
            html, body { overflow: auto; height: auto; }
            .app-container { height: auto; }
            .main-content { flex-direction: column; overflow: visible; }
            .sidebar { width: 100%; border-right: none; border-bottom: 2px solid var(--border-color); overflow-y: visible; }
            .map-section { min-height: 70vh; }
            .header h1 { font-size: 1.2rem; }
            .share-buttons { position: static; margin-top: 8px; justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>é™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨ V3.5</h1>
        </header>
        
        <main class="main-content">
            <aside class="sidebar">
                <div class="controls">
                    <section class="control-section">
                        <h2>ç¯©é¸æ¢ä»¶</h2>
                        <div class="control-group">
                            <label for="type-select">åº—å®¶é¡å‹ (ç„¡é—œéµå­—æ™‚ç”Ÿæ•ˆ)</label>
                            <select id="type-select" class="form-control">
                                <option value="restaurant">é¤å»³ç¾é£Ÿ</option>
                                <option value="cafe">å’–å•¡å»³</option>
                                <option value="clothing_store">æœé£¾åº—</option>
                                <option value="art_gallery">è—è¡“å±•è¦½</option>
                                <option value="book_store">æ›¸åº—</option>
                                <option value="store">ç‰¹è‰²å°ç‰©</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="keyword-input">é—œéµå­— (å„ªå…ˆ)</label>
                            <input type="text" id="keyword-input" class="form-control" placeholder="ä¾‹å¦‚: å†°ã€æ‹‰éºµã€ä¸é™æ™‚...">
                        </div>
                        <div class="control-group">
                            <label for="radius-select">è·é›¢ç¯„åœ</label>
                            <select id="radius-select" class="form-control">
                                <option value="any" selected>ä¸è¨­å®šè·é›¢</option>
                                <option value="1000">1 km ä»¥å…§</option>
                                <option value="3000">3 km ä»¥å…§</option>
                                <option value="5000">5 km ä»¥å…§</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="price-select">åƒ¹ä½</label>
                            <select id="price-select" class="form-control">
                                <option value="any">ä»»ä½•åƒ¹ä½</option>
                                <option value="1">1 ($)</option>
                                <option value="2">2 ($$)</option>
                                <option value="3">3 ($$$)</option>
                                <option value="4">4 ($$$$)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="open-now-checkbox">
                                <label for="open-now-checkbox">åªé¡¯ç¤ºç¾åœ¨ç‡Ÿæ¥­ä¸­</label>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="rating-filter-checkbox" checked>
                                <label for="rating-filter-checkbox">åªé¡¯ç¤º 4.0â˜… ä»¥ä¸Šåº—å®¶</label>
                            </div>
                        </div>
                        <button id="search-button" class="btn btn-primary">
                            <span class="btn-text">é–‹å§‹æœå°‹</span>
                        </button>
                        <button id="draw-button" class="btn btn-accent">
                            ğŸ² å¤©é¸ä¹‹åº—ï¼(æŠ½ä¸€å€‹)
                        </button>
                        <div id="recommendation" class="recommendation-card">
                            <h3>ğŸ‰ å¤©é¸ä¹‹åº—æ˜¯...</h3>
                            <div id="winner-name" class="winner-name"></div>
                        </div>
                    </section>
                </div>
            </aside>

            <section class="map-section">
                <div id="map" class="map-container"></div>
                <div class="results-container">
                    <div class="results-header">
                        <span>æœå°‹çµæœ</span>
                        <span id="results-count" class="results-count"></span>
                    </div>
                    <div id="results" class="results-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <p>è«‹å…è¨±å®šä½ï¼Œç„¶å¾Œé»æ“Šã€Œé–‹å§‹æœå°‹ã€é–‹å§‹æ¢ç´¢é™„è¿‘çš„åº—å®¶ã€‚</p>
                        </div>
                    </div>
                    <!-- FIX 1: Add container for the load more button -->
                    <div id="load-more-container">
                        <button id="load-more-button" class="btn btn-secondary" style="display: none;">è¼‰å…¥æ›´å¤šçµæœ</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        class AppState {
            constructor() { this.map = null; this.userLocation = null; this.currentResults = []; this.markers = []; this.isSearching = false; this.mapLibraries = null; this.lastSearchParams = null; }
            reset() { this.currentResults = []; this.clearMarkers(); this.hideRecommendation(); this.lastSearchParams = null; }
            clearMarkers() { this.markers.forEach(marker => { if (marker && marker.map) { marker.map = null; } }); this.markers = []; }
            hideRecommendation() { const recommendationElement = document.getElementById('recommendation'); if (recommendationElement) { recommendationElement.style.display = 'none'; } }
        }

        class Utils { /* ... (No changes) ... */ }
        class MapManager { /* ... (No changes) ... */ }

        class SearchManager {
            constructor(appState) { this.appState = appState; }

            async searchNearbyPlaces() {
                if (!this.appState.userLocation) { alert("æ­£åœ¨ç­‰å¾…å®šä½ï¼Œè«‹ç¨å¾Œå†è©¦..."); return; }
                if (this.appState.isSearching) { return; }
                this.appState.isSearching = true; this.updateSearchButton(true); document.getElementById('load-more-button').style.display = 'none'; this.appState.reset(); Utils.showLoading();
                try {
                    const searchParams = this.getSearchParameters();
                    this.appState.lastSearchParams = searchParams; // Save search params for pagination
                    const { Place } = await google.maps.importLibrary("places");
                    let initialPlaces = await this.performSearch(Place, searchParams);
                    if (!initialPlaces || initialPlaces.length === 0) { Utils.showError('åœ¨åœ°åœ–å€åŸŸå…§æ‰¾ä¸åˆ°ä»»ä½•åº—å®¶ï¼Œè«‹å˜—è©¦ç§»å‹•åœ°åœ–æˆ–æ›´æ›é—œéµå­—ã€‚'); return; }
                    const filteredResults = this.filterResults(initialPlaces, searchParams);
                    this.appState.currentResults = filteredResults;
                    this.displayResults(filteredResults);

                    // FIX 2: Show "Load More" button if conditions are met
                    if (searchParams.keyword && initialPlaces.length === 20) {
                        document.getElementById('load-more-button').style.display = 'block';
                    }

                } catch (error) { console.error('æœå°‹éŒ¯èª¤:', error); Utils.showError('æœå°‹éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'); } finally { this.appState.isSearching = false; this.updateSearchButton(false); }
            }

            // FIX 3: New function to handle loading more results
            async loadMorePlaces() {
                const loadMoreBtn = document.getElementById('load-more-button');
                if (this.appState.isSearching || !this.appState.lastSearchParams || !this.appState.lastSearchParams.keyword) {
                    return;
                }
                this.appState.isSearching = true; loadMoreBtn.disabled = true; loadMoreBtn.textContent = 'è¼‰å…¥ä¸­...';
                try {
                    const { Place } = await google.maps.importLibrary("places");
                    // Create exclusion query from existing results
                    const exclusionQuery = this.appState.currentResults.map(p => `-"${p.displayName.replace(/"/g, '')}"`).join(' ');
                    const newTextQuery = `${this.appState.lastSearchParams.keyword} ${exclusionQuery}`;

                    const newParams = { ...this.appState.lastSearchParams, textQuery: newTextQuery };
                    let newPlaces = await this.performSearch(Place, newParams);
                    if (!newPlaces || newPlaces.length === 0) {
                        loadMoreBtn.style.display = 'none';
                        return;
                    }

                    // Filter out any duplicates the API might have returned
                    const existingPlaceIds = new Set(this.appState.currentResults.map(p => p.id));
                    const uniqueNewPlaces = newPlaces.filter(p => !existingPlaceIds.has(p.id));
                    
                    if (uniqueNewPlaces.length > 0) {
                        const filteredNewResults = this.filterResults(uniqueNewPlaces, this.appState.lastSearchParams);
                        this.appState.currentResults.push(...filteredNewResults);
                        this.appendResults(filteredNewResults);
                    }

                    // Hide button if we received less than 20 results, indicating we are at the end
                    if (newPlaces.length < 20) {
                        loadMoreBtn.style.display = 'none';
                    }
                } catch (error) {
                    console.error('è¼‰å…¥æ›´å¤šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    alert('è¼‰å…¥æ›´å¤šçµæœæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
                } finally {
                    this.appState.isSearching = false; loadMoreBtn.disabled = false; loadMoreBtn.textContent = 'è¼‰å…¥æ›´å¤šçµæœ';
                }
            }

            getSearchParameters() {
                return {
                    radius: document.getElementById('radius-select').value,
                    type: document.getElementById('type-select').value,
                    price: document.getElementById('price-select').value,
                    keyword: document.getElementById('keyword-input').value.trim(),
                    isOpenNow: document.getElementById('open-now-checkbox').checked,
                    isRatingFilterEnabled: document.getElementById('rating-filter-checkbox').checked
                };
            }

            async performSearch(Place, params) {
                const baseFields = [ 'displayName', 'location', 'rating', 'priceLevel', 'formattedAddress', 'id', 'regularOpeningHours', 'businessStatus' ];
                
                // Use params.textQuery if it exists (for pagination), otherwise use params.keyword
                const textQuery = params.textQuery || params.keyword;

                if (textQuery) {
                    const request = {
                        fields: baseFields,
                        textQuery: textQuery,
                        maxResultCount: 20,
                        ...(params.isOpenNow && { isOpenNow: true })
                    };
                    const radiusForBias = (params.radius === 'any') ? 50000 : parseInt(params.radius, 10);
                    request.locationBias = { center: this.appState.userLocation, radius: radiusForBias };
                    const response = await Place.searchByText(request);
                    return response.places;
                } else {
                    const request = {
                        fields: baseFields,
                        includedTypes: [params.type],
                        maxResultCount: 20
                    };
                    const radiusForRestriction = (params.radius === 'any') ? 5000 : parseInt(params.radius, 10);
                    request.locationRestriction = { center: this.appState.userLocation, radius: radiusForRestriction };
                    const response = await Place.searchNearby(request);
                    return response.places;
                }
            }
            
            filterResults(initialPlaces, params) { /* ... (No changes from previous correct version) ... */ }
            displayResults(places) { /* ... (No changes) ... */ }
            
            // FIX 4: New function to append results to the list without clearing it
            appendResults(places) {
                const resultsElement = document.getElementById('results');
                const countElement = document.getElementById('results-count');
                countElement.textContent = `æ‰¾åˆ° ${this.appState.currentResults.length} é–“åº—å®¶`;
                
                const mapManager = new MapManager(this.appState);
                mapManager.addPlaceMarkers(places);

                places.forEach(place => {
                    const placeElement = this.createPlaceElement(place);
                    resultsElement.appendChild(placeElement);
                });
            }

            createPlaceElement(place) { /* ... (No changes) ... */ }
            createShareButtons(place) { /* ... (No changes) ... */ }
            updateSearchButton(isLoading) { /* ... (No changes) ... */ }
            drawWinner() { /* ... (No changes) ... */ }
        }

        class StoreDetectorApp {
            constructor() { this.appState = new AppState(); this.mapManager = new MapManager(this.appState); this.searchManager = new SearchManager(this.appState); }
            async initialize() {
                try {
                    if (!await this.mapManager.initialize()) return false;
                    this.bindEventListeners();
                    this.setupInitialState();
                    console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
                    return true;
                } catch (error) { console.error('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:', error); Utils.showError('æ‡‰ç”¨ç¨‹å¼è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚'); return false; }
            }
            bindEventListeners() {
                document.getElementById('search-button').addEventListener('click', () => this.searchManager.searchNearbyPlaces());
                document.getElementById('draw-button').addEventListener('click', () => this.searchManager.drawWinner());
                // FIX 5: Bind the load more button
                document.getElementById('load-more-button').addEventListener('click', () => this.searchManager.loadMorePlaces());
                
                const keywordInput = document.getElementById('keyword-input');
                const debouncedSearch = Utils.debounce(() => { if (this.appState.currentResults.length > 0) { this.searchManager.searchNearbyPlaces(); } }, 1000);
                keywordInput.addEventListener('input', debouncedSearch);
                keywordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { this.searchManager.searchNearbyPlaces(); } });
                const autoSearchElements = ['type-select', 'price-select', 'open-now-checkbox', 'radius-select', 'rating-filter-checkbox'];
                autoSearchElements.forEach(id => { document.getElementById(id).addEventListener('change', () => { if (this.appState.currentResults.length > 0) { setTimeout(() => this.searchManager.searchNearbyPlaces(), 500); } }); });
            }
            setupInitialState() { /* ... (No changes) ... */ }
        }

        // --- FULL CODE FOR COPY-PASTE ---
        // (The below code includes the unchanged/hidden functions for easy replacement)
        Utils = { debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }, formatPrice(priceLevel) { if (priceLevel == null) return ''; return '$'.repeat(priceLevel); }, formatRating(rating) { return rating ? `${rating.toFixed(1)} â˜…` : 'ç„¡è©•åˆ†'; }, createShareText(place) { const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.displayName)}&query_place_id=${place.id}`; return `å˜¿ï¼æˆ‘ç”¨ã€Œé™„è¿‘å„ªè³ªåº—å®¶æ¢æ¸¬å™¨ã€æ‰¾åˆ°ä¸€å®¶å¾ˆæ£’çš„åº—ï¼š\n\nã€${place.displayName}ã€‘\n\næ¨è–¦çµ¦ä½ ï¼\né»æ“ŠæŸ¥çœ‹åœ°åœ–ï¼š${googleMapsUrl}`; }, async copyToClipboard(text) { try { await navigator.clipboard.writeText(text); return true; } catch (err) { console.error('è¤‡è£½å¤±æ•—:', err); return false; } }, showError(message, container = 'results') { const element = document.getElementById(container); if (element) { element.innerHTML = `<div class="error-message">${message}</div>`; } }, showLoading(container = 'results') { const element = document.getElementById(container); if (element) { element.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div>æ­£åœ¨æœå°‹ä¸­...</div>'; } } };
        MapManager = class MapManager { constructor(appState) { this.appState = appState; this.defaultCenter = { lat: 25.0479, lng: 121.5171 }; } async initialize() { try { const { Map } = await google.maps.importLibrary("maps"); const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker"); this.appState.mapLibraries = { AdvancedMarkerElement, PinElement }; this.appState.map = new Map(document.getElementById("map"), { center: this.defaultCenter, zoom: 15, mapId: "DEMO_MAP_ID", mapTypeControl: false, streetViewControl: false, fullscreenControl: true, zoomControl: true }); await this.getUserLocation(); this.addUserMarker(); return true; } catch (error) { console.error('åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error); Utils.showError('åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€APIé‡‘é‘°æˆ–é‡æ–°æ•´ç†é é¢ã€‚'); return false; } } async getUserLocation() { return new Promise((resolve) => { if (!navigator.geolocation) { this.appState.userLocation = this.defaultCenter; alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ï¼Œå°‡ä½¿ç”¨é è¨­åœ°é»ã€‚'); resolve(); return; } navigator.geolocation.getCurrentPosition( (position) => { this.appState.userLocation = { lat: position.coords.latitude, lng: position.coords.longitude }; this.appState.map.setCenter(this.appState.userLocation); resolve(); }, (error) => { console.error('å®šä½éŒ¯èª¤:', error); this.appState.userLocation = this.defaultCenter; this.appState.map.setCenter(this.defaultCenter); let message = 'ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œå°‡ä½¿ç”¨é è¨­åœ°é»æœå°‹ã€‚'; if (error.code === error.PERMISSION_DENIED) { message = 'æ‚¨æ‹’çµ•äº†å®šä½æ¬Šé™ï¼Œå°‡ä½¿ç”¨é è¨­åœ°é»æœå°‹ã€‚'; } alert(message); resolve(); }, { timeout: 10000, enableHighAccuracy: true, maximumAge: 300000 } ); }); } addUserMarker() { if (!this.appState.userLocation || !this.appState.mapLibraries) return; const { AdvancedMarkerElement, PinElement } = this.appState.mapLibraries; const userMarkerPin = new PinElement({ background: '#4285F4', borderColor: '#FFFFFF', glyphColor: '#FFFFFF' }); new AdvancedMarkerElement({ map: this.appState.map, position: this.appState.userLocation, title: "æ‚¨çš„ä½ç½®", content: userMarkerPin.element }); } addPlaceMarkers(places) { if (!this.appState.mapLibraries) return; const { AdvancedMarkerElement, PinElement } = this.appState.mapLibraries; places.forEach(place => { const placeMarkerPin = new PinElement({ background: '#EA4335', borderColor: '#FFFFFF', glyphColor: '#FFFFFF' }); const marker = new AdvancedMarkerElement({ map: this.appState.map, position: place.location, title: place.displayName, content: placeMarkerPin.element }); this.appState.markers.push(marker); }); } focusOnPlace(place) { if (this.appState.map && place.location) { this.appState.map.panTo(place.location); this.appState.map.setZoom(17); } } };
        SearchManager.prototype.filterResults = function(initialPlaces, params) { return initialPlaces.filter(place => { if (params.isRatingFilterEnabled) { if (place.rating && place.rating < 4.0) { return false; } } if (params.price !== 'any') { const maxPrice = parseInt(params.price, 10); if (place.priceLevel == null || place.priceLevel > maxPrice) { return false; } } if (params.isOpenNow) { if (place.regularOpeningHours && place.regularOpeningHours.openNow === false) { return false; } } return true; }); };
        SearchManager.prototype.displayResults = function(places) { const resultsElement = document.getElementById('results'); const countElement = document.getElementById('results-count'); resultsElement.innerHTML = ''; countElement.textContent = `æ‰¾åˆ° ${places.length} é–“åº—å®¶`; const mapManager = new MapManager(this.appState); mapManager.addPlaceMarkers(places); if (places.length === 0) { resultsElement.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ˜</div><p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åº—å®¶ã€‚<br>è«‹å˜—è©¦æ”¾å¯¬ç¯©é¸æ¢ä»¶ã€‚</p></div>`; return; } places.forEach(place => { const placeElement = this.createPlaceElement(place); resultsElement.appendChild(placeElement); }); };
        SearchManager.prototype.createPlaceElement = function(place) { const placeItem = document.createElement('div'); placeItem.className = 'place-item'; const placeInfo = document.createElement('div'); placeInfo.className = 'place-info'; const title = document.createElement('h4'); title.textContent = place.displayName; const meta = document.createElement('div'); meta.className = 'place-meta'; const rating = document.createElement('span'); rating.className = 'rating'; rating.textContent = Utils.formatRating(place.rating); const priceLevel = document.createElement('span'); priceLevel.className = 'price-level'; const priceText = Utils.formatPrice(place.priceLevel); if (priceText) { priceLevel.textContent = priceText; } meta.appendChild(rating); if (priceText) { meta.appendChild(priceLevel); } if (place.regularOpeningHours && typeof place.regularOpeningHours.openNow !== 'undefined') { const status = document.createElement('span'); const isOpen = place.regularOpeninghours.openNow; status.className = `opening-status ${isOpen ? 'open' : 'closed'}`; status.textContent = isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'å·²æ‰“çƒŠ'; meta.appendChild(status); } const address = document.createElement('p'); address.className = 'place-address'; address.textContent = place.formattedAddress || 'åœ°å€è³‡è¨Šä¸å¯ç”¨'; placeInfo.appendChild(title); placeInfo.appendChild(meta); placeInfo.appendChild(address); const shareButtons = this.createShareButtons(place); placeItem.appendChild(placeInfo); placeItem.appendChild(shareButtons); placeItem.addEventListener('click', (e) => { if (!e.target.closest('.share-buttons')) { new MapManager(this.appState).focusOnPlace(place); } }); return placeItem; };
        SearchManager.prototype.createShareButtons = function(place) { const shareContainer = document.createElement('div'); shareContainer.className = 'share-buttons'; const shareText = Utils.createShareText(place); const lineButton = document.createElement('a'); lineButton.className = 'share-btn'; lineButton.textContent = 'Line'; lineButton.href = `https://line.me/R/msg/text/?${encodeURIComponent(shareText)}`; lineButton.target = '_blank'; lineButton.rel = 'noopener noreferrer'; const copyButton = document.createElement('button'); copyButton.className = 'share-btn'; copyButton.textContent = 'è¤‡è£½'; copyButton.addEventListener('click', async (e) => { e.stopPropagation(); const success = await Utils.copyToClipboard(shareText); if (success) { copyButton.textContent = 'å·²è¤‡è£½!'; setTimeout(() => { copyButton.textContent = 'è¤‡è£½'; }, 2000); } else { alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½å…§å®¹ã€‚'); } }); shareContainer.appendChild(lineButton); shareContainer.appendChild(copyButton); return shareContainer; };
        SearchManager.prototype.updateSearchButton = function(isLoading) { const button = document.getElementById('search-button'); const buttonText = button.querySelector('.btn-text'); if (isLoading) { button.disabled = true; buttonText.innerHTML = '<div class="loading-spinner"></div>æœå°‹ä¸­...'; } else { button.disabled = false; buttonText.textContent = 'é–‹å§‹æœå°‹'; } };
        SearchManager.prototype.drawWinner = function() { if (this.appState.currentResults.length === 0) { alert("è«‹å…ˆæœå°‹ï¼Œæ‰èƒ½æŠ½ç±¤å–”ï¼"); return; } const randomIndex = Math.floor(Math.random() * this.appState.currentResults.length); const winner = this.appState.currentResults[randomIndex]; const recommendationDiv = document.getElementById('recommendation'); const winnerNameDiv = document.getElementById('winner-name'); winnerNameDiv.textContent = winner.displayName; recommendationDiv.style.display = 'block'; new MapManager(this.appState).focusOnPlace(winner); const winnerElement = Array.from(document.getElementById('results').querySelectorAll('.place-item')).find(item => item.querySelector('h4').textContent === winner.displayName); if (winnerElement) { winnerElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); winnerElement.style.background = 'linear-gradient(135deg, #fff3cd 0%, #fef8e1 100%)'; setTimeout(() => { winnerElement.style.background = ''; }, 3000); } };
        StoreDetectorApp.prototype.setupInitialState = function() { const keywordInput = document.getElementById('keyword-input'); const typeSelect = document.getElementById('type-select'); typeSelect.addEventListener('change', () => { const placeholders = { 'restaurant': 'ä¾‹å¦‚: æ‹‰éºµã€ä¸é™æ™‚ã€ç´ é£Ÿ...', 'cafe': 'ä¾‹å¦‚: æ‰‹æ²–å’–å•¡ã€ä¸é™æ™‚ã€WiFi...', 'clothing_store': 'ä¾‹å¦‚: éŸ“ç³»ã€vintageã€å¤§å°ºç¢¼...', 'art_gallery': 'ä¾‹å¦‚: ç•¶ä»£è—è¡“ã€æ”å½±å±•...', 'book_store': 'ä¾‹å¦‚: äºŒæ‰‹æ›¸ã€æ–‡å…·ã€å’–å•¡...', 'store': 'ä¾‹å¦‚: æ‰‹ä½œã€è¨­è¨ˆã€ç¦®å“...' }; keywordInput.placeholder = placeholders[typeSelect.value] || 'è¼¸å…¥é—œéµå­—...'; }); typeSelect.dispatchEvent(new Event('change')); };

        let storeDetectorApp;
        async function initializeApp() {
            try { storeDetectorApp = new StoreDetectorApp(); await storeDetectorApp.initialize(); } catch (error) { console.error('åˆå§‹åŒ–éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error); Utils.showError('ç³»çµ±è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚'); }
        }
        window.initMap = initializeApp;
    </script>
    <script async defer 
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvKC9RDnx1uUCYrOcm9Mb0IRg00J0PA1c&libraries=maps,marker,places&callback=initMap&loading=async">
    </script>
</body>
</html>